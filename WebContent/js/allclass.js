Ext.define("Ext.ux.desktop.Module",{mixins:{observable:"Ext.util.Observable"},constructor:function(a){this.config=a||{};this.mixins.observable.constructor.call(this,a);this.init()},init:Ext.emptyFn});Ext.define("Ext.ux.desktop.ShortcutModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"iconCls"},{name:"module"}]});
Ext.define("Ext.ux.desktop.StartMenu",{extend:"Ext.panel.Panel",requires:["Ext.menu.Menu","Ext.toolbar.Toolbar"],ariaRole:"menu",cls:"x-menu ux-start-menu",defaultAlign:"bl-tl",iconCls:"user",floating:!0,shadow:!0,width:300,initComponent:function(){var a=this;a.menu=new Ext.menu.Menu({cls:"ux-start-menu-body",border:!1,floating:!1,items:a.menu});a.menu.layout.align="stretch";a.items=[a.menu];a.layout="fit";Ext.menu.Manager.register(a);a.callParent();a.toolbar=new Ext.toolbar.Toolbar(Ext.apply({dock:"right",
cls:"ux-start-menu-toolbar",vertical:!0,width:100},a.toolConfig));a.toolbar.layout.align="stretch";a.addDocked(a.toolbar);delete a.toolItems;a.on("deactivate",function(){a.hide()})},addMenuItem:function(){var a=this.menu;a.add.apply(a,arguments)},addToolItem:function(){var a=this.toolbar;a.add.apply(a,arguments)},showBy:function(a,b,c){this.floating&&a&&(this.layout.autoSize=!0,this.show(),a=a.el||a,a=this.el.getAlignToXY(a,b||this.defaultAlign,c),this.floatParent&&(b=this.floatParent.getTargetEl().getViewRegion(),
a[0]-=b.x,a[1]-=b.y),this.showAt(a),this.doConstrain());return this}});
Ext.define("Ext.ux.desktop.TaskBar",{extend:"Ext.toolbar.Toolbar",requires:["Ext.button.Button","Ext.resizer.Splitter","Ext.menu.Menu","Ext.ux.desktop.StartMenu"],alias:"widget.taskbar",cls:"ux-taskbar",startBtnText:"Start",initComponent:function(){this.startMenu=new Ext.ux.desktop.StartMenu(this.startConfig);this.quickStart=new Ext.toolbar.Toolbar(this.getQuickStart());this.windowBar=new Ext.toolbar.Toolbar(this.getWindowBarConfig());this.tray=new Ext.toolbar.Toolbar(this.getTrayConfig());this.items=
[{xtype:"button",cls:"ux-start-button",iconCls:"ux-start-button-icon",menu:this.startMenu,menuAlign:"bl-tl",text:this.startBtnText},this.quickStart,{xtype:"splitter",html:"&#160;",height:14,width:2,cls:"x-toolbar-separator x-toolbar-separator-horizontal"},this.windowBar,"-",this.tray];this.callParent()},afterLayout:function(){this.callParent();this.windowBar.el.on("contextmenu",this.onButtonContextMenu,this)},getQuickStart:function(){var a=this,b={minWidth:20,width:60,items:[],enableOverflow:!0};
Ext.each(this.quickStart,function(c){b.items.push({tooltip:{text:c.tooltipText||c.name,align:"bl-tl"},overflowText:c.name,iconCls:c.iconCls,module:c.module,handler:c.handler||a.onQuickStartClick,scope:a})});return b},getTrayConfig:function(){var a={width:80,items:this.trayItems};delete this.trayItems;return a},getWindowBarConfig:function(){return{flex:1,cls:"ux-desktop-windowbar",items:["&#160;"],layout:{overflowHandler:"Scroller"}}},getWindowBtnFromEl:function(a){return this.windowBar.getChildByElement(a)||
null},onQuickStartClick:function(a){if(a=this.app.getModule(a.module))a=a.createWindow(),a.show()},onButtonContextMenu:function(a){var b=a.getTarget(),c=this.getWindowBtnFromEl(b);c&&(a.stopEvent(),this.windowMenu.theWin=c.win,this.windowMenu.showBy(b))},onWindowBtnClick:function(a){a=a.win;a.minimized||a.hidden?a.show():a.active?a.minimize():a.toFront()},addTaskButton:function(a){a=this.windowBar.add({iconCls:a.iconCls,enableToggle:!0,toggleGroup:"all",width:140,margins:"0 2 0 3",text:Ext.util.Format.ellipsis(a.title,
20),listeners:{click:this.onWindowBtnClick,scope:this},win:a});a.toggle(!0);return a},removeTaskButton:function(a){var b;this.windowBar.items.each(function(c){c===a&&(b=c);return!b});b&&this.windowBar.remove(b);return b},setActiveButton:function(a){a?a.toggle(!0):this.windowBar.items.each(function(a){a.isButton&&a.toggle(!1)})}});
Ext.define("Ext.ux.desktop.TrayClock",{extend:"Ext.toolbar.TextItem",alias:"widget.trayclock",cls:"ux-desktop-trayclock",html:"&#160;",timeFormat:"g:i A",tpl:"{time}",initComponent:function(){this.callParent();"string"==typeof this.tpl&&(this.tpl=new Ext.XTemplate(this.tpl))},afterRender:function(){Ext.Function.defer(this.updateTime,100,this);this.callParent()},onDestroy:function(){this.timer&&(window.clearTimeout(this.timer),this.timer=null);this.callParent()},updateTime:function(){var a=this.tpl.apply({time:Ext.Date.format(new Date,
this.timeFormat)});this.lastText!=a&&(this.setText(a),this.lastText=a);this.timer=Ext.Function.defer(this.updateTime,1E4,this)}});
Ext.define("Ext.ux.desktop.Wallpaper",{extend:"Ext.Component",alias:"widget.wallpaper",cls:"ux-wallpaper",html:'<img src="'+Ext.BLANK_IMAGE_URL+'">',stretch:!1,wallpaper:null,stateful:!0,stateId:"desk-wallpaper",afterRender:function(){this.callParent();this.setWallpaper(this.wallpaper,this.stretch)},applyState:function(){var a=this.wallpaper;this.callParent(arguments);a!=this.wallpaper&&this.setWallpaper(this.wallpaper)},getState:function(){return this.wallpaper&&{wallpaper:this.wallpaper}},setWallpaper:function(a,
b){var c,d;this.stretch=!1!==b;this.wallpaper=a;this.rendered&&(c=this.el.dom.firstChild,!a||a==Ext.BLANK_IMAGE_URL?Ext.fly(c).hide():this.stretch?(c.src=a,this.el.removeCls("ux-wallpaper-tiled"),Ext.fly(c).setStyle({width:"100%",height:"100%"}).show()):(Ext.fly(c).hide(),d="url("+a+")",this.el.addCls("ux-wallpaper-tiled")),this.el.setStyle({backgroundImage:d||""}),this.stateful&&this.saveState());return this}});
Ext.define("Ext.ux.desktop.Desktop",{extend:"Ext.panel.Panel",alias:"widget.desktop",uses:"Ext.util.MixedCollection Ext.menu.Menu Ext.view.View Ext.window.Window Ext.ux.desktop.TaskBar Ext.ux.desktop.Wallpaper".split(" "),activeWindowCls:"ux-desktop-active-win",inactiveWindowCls:"ux-desktop-inactive-win",lastActiveWindow:null,border:!1,html:"&#160;",layout:"fit",xTickSize:1,yTickSize:1,app:null,shortcuts:null,shortcutItemSelector:"div.ux-desktop-shortcut",shortcutTpl:['<tpl for=".">','<div class="ux-desktop-shortcut" id="{name}-shortcut">',
'<div class="ux-desktop-shortcut-icon {iconCls}">','<img src="',Ext.BLANK_IMAGE_URL,'" title="{name}">',"</div>",'<span class="ux-desktop-shortcut-text">{name}</span>',"</div>","</tpl>",'<div class="x-clear"></div>'],taskbarConfig:null,windowMenu:null,initComponent:function(){this.windowMenu=new Ext.menu.Menu(this.createWindowMenu());this.bbar=this.taskbar=new Ext.ux.desktop.TaskBar(this.taskbarConfig);this.taskbar.windowMenu=this.windowMenu;this.windows=new Ext.util.MixedCollection;this.contextMenu=
new Ext.menu.Menu(this.createDesktopMenu());this.items=[{xtype:"wallpaper",id:this.id+"_wallpaper"},this.createDataView()];this.callParent();this.shortcutsView=this.items.getAt(1);this.shortcutsView.on("itemclick",this.onShortcutItemClick,this);var a=this.wallpaper;this.wallpaper=this.items.getAt(0);a&&this.setWallpaper(a,this.wallpaperStretch)},afterRender:function(){this.callParent();this.el.on("contextmenu",this.onDesktopMenu,this)},createDataView:function(){return{xtype:"dataview",overItemCls:"x-view-over",
trackOver:!0,itemSelector:this.shortcutItemSelector,store:this.shortcuts,style:{position:"absolute"},x:0,y:0,tpl:new Ext.XTemplate(this.shortcutTpl)}},createDesktopMenu:function(){var a={items:this.contextMenuItems||[]};a.items.length&&a.items.push("-");a.items.push({text:"平铺",handler:this.tileWindows,scope:this,minWindows:1},{text:"折叠",handler:this.cascadeWindows,scope:this,minWindows:1});return a},createWindowMenu:function(){return{defaultAlign:"br-tr",items:[{text:"Restore",handler:this.onWindowMenuRestore,
scope:this},{text:"Minimize",handler:this.onWindowMenuMinimize,scope:this},{text:"Maximize",handler:this.onWindowMenuMaximize,scope:this},"-",{text:"Close",handler:this.onWindowMenuClose,scope:this}],listeners:{beforeshow:this.onWindowMenuBeforeShow,hide:this.onWindowMenuHide,scope:this}}},onDesktopMenu:function(a){var b=this.contextMenu;a.stopEvent();if(!b.rendered)b.on("beforeshow",this.onDesktopMenuBeforeShow,this);b.showAt(a.getXY());b.doConstrain()},onDesktopMenuBeforeShow:function(a){var b=
this.windows.getCount();a.items.each(function(a){a.setDisabled(b<(a.minWindows||0))})},onShortcutItemClick:function(a,b){var c=this.app.getModule(b.data.module);(c=c&&c.createWindow())&&this.restoreWindow(c)},onWindowClose:function(a){this.windows.remove(a);this.taskbar.removeTaskButton(a.taskButton);this.updateActiveWindow()},onWindowMenuBeforeShow:function(a){var b=a.items.items,a=a.theWin;b[0].setDisabled(!0!==a.maximized&&!0!==a.hidden);b[1].setDisabled(!0===a.minimized);b[2].setDisabled(!0===
a.maximized||!0===a.hidden)},onWindowMenuClose:function(){this.windowMenu.theWin.close()},onWindowMenuHide:function(a){a.theWin=null},onWindowMenuMaximize:function(){var a=this.windowMenu.theWin;a.maximize();a.toFront()},onWindowMenuMinimize:function(){this.windowMenu.theWin.minimize()},onWindowMenuRestore:function(){this.restoreWindow(this.windowMenu.theWin)},getWallpaper:function(){return this.wallpaper.wallpaper},setTickSize:function(a,b){var c=this.xTickSize=a,d=this.yTickSize=1<arguments.length?
b:c;this.windows.each(function(a){var b=a.dd,a=a.resizer;b.xTickSize=c;b.yTickSize=d;a.widthIncrement=c;a.heightIncrement=d})},setWallpaper:function(a,b){this.wallpaper.setWallpaper(a,b);return this},cascadeWindows:function(){var a=0,b=0;this.getDesktopZIndexManager().eachBottomUp(function(c){c.isWindow&&(c.isVisible()&&!c.maximized)&&(c.setPosition(a,b),a+=20,b+=20)})},createWindow:function(a,b){var c=this,d,e=Ext.applyIf(a||{},{stateful:!1,isWindow:!0,constrainHeader:!0,minimizable:!0,maximizable:!0}),
b=b||Ext.window.Window;d=c.add(new b(e));c.windows.add(d);d.taskButton=c.taskbar.addTaskButton(d);d.animateTarget=d.taskButton.el;d.on({activate:c.updateActiveWindow,beforeshow:c.updateActiveWindow,deactivate:c.updateActiveWindow,minimize:c.minimizeWindow,destroy:c.onWindowClose,scope:c});d.on({boxready:function(){d.dd.xTickSize=c.xTickSize;d.dd.yTickSize=c.yTickSize;d.resizer&&(d.resizer.widthIncrement=c.xTickSize,d.resizer.heightIncrement=c.yTickSize)},single:!0});d.doClose=function(){d.doClose=
Ext.emptyFn;d.el.disableShadow();d.el.fadeOut({listeners:{afteranimate:function(){d.destroy()}}})};return d},getActiveWindow:function(){var a=null,b=this.getDesktopZIndexManager();b&&b.eachTopDown(function(b){return b.isWindow&&!b.hidden?(a=b,!1):!0});return a},getDesktopZIndexManager:function(){var a=this.windows;return a.getCount()&&a.getAt(0).zIndexManager||null},getWindow:function(a){return this.windows.get(a)},minimizeWindow:function(a){a.minimized=!0;a.hide()},restoreWindow:function(a){a.isVisible()?
(a.restore(),a.toFront()):a.show();return a},tileWindows:function(){var a=this,b=a.body.getWidth(!0),c=a.xTickSize,d=a.yTickSize,e=d;a.windows.each(function(f){if(f.isVisible()&&!f.maximized){var g=f.el.getWidth();c>a.xTickSize&&c+g>b&&(c=a.xTickSize,d=e);f.setPosition(c,d);c+=g+a.xTickSize;e=Math.max(e,d+f.el.getHeight()+a.yTickSize)}})},updateActiveWindow:function(){var a=this.getActiveWindow(),b=this.lastActiveWindow;if(a!==b){b&&(b.el.dom&&(b.addCls(this.inactiveWindowCls),b.removeCls(this.activeWindowCls)),
b.active=!1);if(this.lastActiveWindow=a)a.addCls(this.activeWindowCls),a.removeCls(this.inactiveWindowCls),a.minimized=!1,a.active=!0;this.taskbar.setActiveButton(a&&a.taskButton)}}});
Ext.define("Ext.ux.desktop.App",{mixins:{observable:"Ext.util.Observable"},requires:["Ext.container.Viewport","Ext.ux.desktop.Desktop"],isReady:!1,modules:null,useQuickTips:!0,constructor:function(a){this.addEvents("ready","beforeunload");this.mixins.observable.constructor.call(this,a);if(Ext.isReady)Ext.Function.defer(this.init,10,this);else Ext.onReady(this.init,this)},init:function(){var a;this.useQuickTips&&Ext.QuickTips.init();(this.modules=this.getModules())&&this.initModules(this.modules);
a=this.getDesktopConfig();this.desktop=new Ext.ux.desktop.Desktop(a);this.viewport=new Ext.container.Viewport({layout:"fit",items:[this.desktop]});Ext.EventManager.on(window,"beforeunload",this.onUnload,this);this.isReady=!0;this.fireEvent("ready",this)},getDesktopConfig:function(){var a={app:this,taskbarConfig:this.getTaskbarConfig()};Ext.apply(a,this.desktopConfig);return a},getModules:Ext.emptyFn,getStartConfig:function(){var a=this,b={app:a,menu:[]},c;Ext.apply(b,a.startConfig);Ext.each(a.modules,
function(d){if(c=d.launcher)c.handler=c.handler||Ext.bind(a.createWindow,a,[d]),b.menu.push(d.launcher)});return b},createWindow:function(a){a.createWindow().show()},getTaskbarConfig:function(){var a={app:this,startConfig:this.getStartConfig()};Ext.apply(a,this.taskbarConfig);return a},initModules:function(a){var b=this;Ext.each(a,function(a){a.app=b})},getModule:function(a){for(var b=this.modules,c=0,d=b.length;c<d;c++){var e=b[c];if(e.id==a||e.appType==a)return e}return null},onReady:function(a,
b){if(this.isReady)a.call(b,this);else this.on({ready:a,scope:b,single:!0})},getDesktop:function(){return this.desktop},onUnload:function(a){!1===this.fireEvent("beforeunload",this)&&a.stopEvent()}});Ext.define("WJM.FormWriter",{extend:"Ext.data.writer.Writer",writeRecords:function(a,b){if(1<b.length)throw Error("保存失败");b=b[0];Ext.Object.each(b,function(b,d){a.params[b]=d});return a}});
Ext.define("WJM.MenuItem",{extend:"Ext.ux.desktop.Module",menuText:"",menuItems:[],iconCls:"",moduleId:null,init:function(){this.launcher={text:this.menuText,iconCls:this.iconCls,handler:function(){return!1},scope:this};this.moduleId&&Ext.apply(this.launcher,{handler:this.onMenuClick,moduleId:this.moduleId});0<this.menuItems.length&&Ext.apply(this.launcher,{menu:{items:[]}});for(var a=0;a<this.menuItems.length;++a)this.launcher.menu.items.push({text:this.menuItems[a].menuText,iconCls:this.menuItems[a].iconClsSmall||
"",handler:this.onMenuClick,scope:this,moduleId:this.menuItems[a].moduleId})},onMenuClick:function(a){(a=this.app.getModule(a.moduleId))&&this.app.createWindow(a)}});Ext.define("WJM.WallpaperModel",{extend:"Ext.data.Model",fields:[{name:"text"},{name:"img"}]});
Ext.define("WJM.Settings",{extend:"Ext.window.Window",uses:"Ext.tree.Panel Ext.tree.View Ext.form.field.Checkbox Ext.layout.container.Anchor Ext.layout.container.Border Ext.ux.desktop.Wallpaper WJM.WallpaperModel".split(" "),layout:"anchor",title:"Change Settings",modal:!0,width:640,height:480,border:!1,initComponent:function(){var a=this;a.selected=a.desktop.getWallpaper();a.stretch=a.desktop.wallpaper.stretch;a.preview=Ext.create("widget.wallpaper");a.preview.setWallpaper(a.selected);a.tree=a.createTree();
a.buttons=[{text:"OK",handler:a.onOK,scope:a},{text:"Cancel",handler:a.close,scope:a}];a.items=[{anchor:"0 -30",border:!1,layout:"border",items:[a.tree,{xtype:"panel",title:"Preview",region:"center",layout:"fit",items:[a.preview]}]},{xtype:"checkbox",boxLabel:"Stretch to fit",checked:a.stretch,listeners:{change:function(b){a.stretch=b.checked}}}];a.callParent()},createTree:function(){function a(a){return{img:a,text:b.getTextOfWallpaper(a),iconCls:"",leaf:!0}}var b=this;return new Ext.tree.Panel({title:"Desktop Background",
rootVisible:!1,lines:!1,autoScroll:!0,width:150,region:"west",split:!0,minWidth:100,listeners:{afterrender:{fn:this.setInitialSelection,delay:100},select:this.onSelect,scope:this},store:new Ext.data.TreeStore({model:"WJM.WallpaperModel",root:{text:"Wallpaper",expanded:!0,children:[{text:"None",iconCls:"",leaf:!0},a("Blue-Sencha.jpg"),a("Dark-Sencha.jpg"),a("Wood-Sencha.jpg"),a("blue.jpg"),a("desk.jpg"),a("desktop.jpg"),a("desktop2.jpg"),a("sky.jpg")]}})})},getTextOfWallpaper:function(a){var b=a,a=
a.lastIndexOf("/");0<=a&&(b=b.substring(a+1));a=b.lastIndexOf(".");b=Ext.String.capitalize(b.substring(0,a));return b=b.replace(/[-]/g," ")},onOK:function(){this.selected&&this.desktop.setWallpaper(this.selected,this.stretch);this.destroy()},onSelect:function(a,b){this.selected=b.data.img?"wallpapers/"+b.data.img:Ext.BLANK_IMAGE_URL;this.preview.setWallpaper(this.selected)},setInitialSelection:function(){var a=this.desktop.getWallpaper();a&&this.tree.selectPath("/Wallpaper/"+this.getTextOfWallpaper(a),
"text")}});Ext.define("WJM.ShortcutModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"iconCls"},{name:"module"},{name:"powerId"}]});
Ext.define("Ext.ux.grid.Printer",{requires:"Ext.XTemplate",statics:{print:function(a){var b=[];Ext.each(a.columns,function(a){0<a.items.length?b=b.concat(a.items.items):b.push(a)});var c=[];a.store.data.each(function(d,e){var f={},g;for(g in d.data){var h=d.data[g];Ext.each(b,function(b,c){if(b.dataIndex==g){var f={item:"",tdAttr:"",style:""};h=b.renderer?b.renderer.call(a,h,f,d,e,c,a.store,a.view):h}},this);f[g]=h}c.push(f)});var d=[];Ext.each(b,function(a){!Ext.isEmpty(a.dataIndex)&&!a.hidden&&
d.push(a)});b=d;if(null===this.stylesheetPath){var e=Ext.Loader.getPath("Ext.ux.grid.Printer");this.stylesheetPath=e.substring(0,e.indexOf("Printer.js"))+"gridPrinterCss/print.css"}var e=Ext.create("Ext.XTemplate",this.headerTpl).apply(b),f=Ext.create("Ext.XTemplate",this.bodyTpl).apply(b),g="",h=[];Ext.each(a.plugins,function(a){"rowexpander"==a.ptype&&(g+=a.rowBodyTpl.join(""))});""!=g&&(h=['<tr class="{[xindex % 2 === 0 ? "even" : "odd"]}"><td colspan="'+b.length+'">',g,"</td></tr>"]);e=['<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">',
'<html class="'+Ext.baseCSSPrefix+'ux-grid-printer">',"<head>",'<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />','<link href="'+this.stylesheetPath+'" rel="stylesheet" type="text/css" />',"<title>"+a.title+"</title>","</head>",'<body class="'+Ext.baseCSSPrefix+'ux-grid-printer-body">','<div class="'+Ext.baseCSSPrefix+"ux-grid-printer-noprint "+Ext.baseCSSPrefix+'ux-grid-printer-links">','<a class="'+Ext.baseCSSPrefix+'ux-grid-printer-linkprint" href="javascript:void(0);" onclick="window.print();">'+
this.printLinkText+"</a>",'<a class="'+Ext.baseCSSPrefix+'ux-grid-printer-linkclose" href="javascript:void(0);" onclick="window.close();">'+this.closeLinkText+"</a>","</div>","<h1>"+this.mainTitle+"</h1>","<table>","<tr>",e,"</tr>",'<tpl for=".">','<tr class="{[xindex % 2 === 0 ? "even" : "odd"]}">',f,"</tr>",h.join(""),"</tpl>","</table>","</body>","</html>"];e=Ext.create("Ext.XTemplate",e).apply(c);f=window.open("","printgrid");f.document.open();f.document.write(e);f.document.close();this.printAutomatically&&
(Ext.isIE?window.print():f.print());this.closeAutomaticallyAfterPrint&&(Ext.isIE?window.close():f.close())},stylesheetPath:null,printAutomatically:!1,closeAutomaticallyAfterPrint:!1,mainTitle:"",printLinkText:"Print",closeLinkText:"Close",headerTpl:['<tpl for=".">',"<th>{text}</th>","</tpl>"],bodyTpl:['<tpl for=".">',"<td>{{dataIndex}}</td>","</tpl>"]}});
Ext.define("Ext.ux.form.field.AdNumberField",{extend:"Ext.form.field.Number",alias:["widget.adnumberfield"],format:"0.00",valueToRaw:function(a){var b=this.decimalSeparator,a=this.parseValue(a),a=this.fixPrecision(a),a=Ext.isNumber(a)?a:parseFloat((""+a).replace(b,"."));this.format&&(a=Ext.util.Format.number(a,this.format));return a=isNaN(a)?"":(""+a).replace(".",b)}});
Ext.define("Ext.ux.CheckColumn",{extend:"Ext.grid.column.Column",alias:"widget.checkcolumn",stopSelection:!0,tdCls:Ext.baseCSSPrefix+"grid-cell-checkcolumn",constructor:function(){this.addEvents("beforecheckchange","checkchange");this.callParent(arguments)},processEvent:function(a,b,c,d,e,f){var g="keydown"===a&&f.getKey(),h="mousedown"==a;if(h||g==f.ENTER||g==f.SPACE){var g=b.panel.store.getAt(d),j=this.dataIndex,i=!g.get(j);return!1!==this.fireEvent("beforecheckchange",this,d,i)?(g.set(j,i),this.fireEvent("checkchange",
this,d,i),h&&f.stopEvent(),this.stopSelection||b.selModel.selectByPosition({row:d,column:e}),!1):!this.stopSelection}return this.callParent(arguments)},renderer:function(a){var b=Ext.baseCSSPrefix,c=[b+"grid-checkheader"];a&&c.push(b+"grid-checkheader-checked");return'<div class="'+c.join(" ")+'">&#160;</div>'}});
Ext.define("WJM.model.TCompany",{extend:"Ext.data.Model",fields:[{name:"company_name"},{name:"company_address"},{name:"company_tel"},{name:"company_fax"},{name:"company_name_pic_logo"},{name:"company_logo_pic_logo"},{name:"invoiceTax"}],proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/setting.do?action=saveCompany",read:location.context+"/setting.do?action=getCompany",update:location.context+"/company.do?action=update",destroy:location.context+
"/company.do?action=del"},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});
Ext.define("WJM.model.TCustomer",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id"},{name:"type"},{name:"code"},{name:"shortName"},{name:"allName"},{name:"address"},{name:"postCode"},{name:"tel1"},{name:"tel2"},{name:"tel3"},{name:"mobile"},{name:"FAX"},{name:"EMail"},{name:"http"},{name:"accounts"},{name:"taxCode"},{name:"linkMan"},{name:"companyType"},{name:"helpName"},{name:"recDate"},{name:"myMemo"},{name:"state"},{name:"city"},{name:"leav_money"},{name:"credit_Line"},{name:"balance"},
{name:"bank_Name"},{name:"bank_Acount"},{name:"credit_Acount"},{name:"passwd"},{name:"total"},{name:"acc_balance",convert:function(a,b){return b.data.leav_money-b.data.balance}},{name:"show_leav_money",convert:function(a,b){return-b.data.leav_money}}],validations:[{type:"length",field:"shortName",min:1}]});
Ext.define("WJM.model.CustomerBaseStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!0,model:"WJM.model.TCustomer",pageSize:25,storeId:"CustomerStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/buyer.do?action=save",read:location.context+"/buyer.do?action=list",update:location.context+"/buyer.do?action=update",destroy:location.context+"/buyer.do?action=del"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",
messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示","保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});Ext.create("WJM.model.CustomerBaseStore",{storeId:"CustomerSearchStore"});
Ext.create("WJM.model.CustomerBaseStore",{storeId:"CustomerQuickStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:"",read:location.context+"/buyer.do?action=quicklist",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示",
"保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});Ext.define("WJM.model.TDamageReport",{extend:"Ext.data.Model",idProperty:"product_name",fields:[{name:"product_name"},{name:"all_price"},{name:"rma_num"}]});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TDamageReport",storeId:"DamageReportStore",proxy:{batchActions:!0,type:"ajax",api:{create:"",read:location.context+"/sale.do?action=damageRepor",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||
"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.define("WJM.model.TEmployee",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"name"},{name:"code"},{name:"sex"},{name:"birthDay"},{name:"iDCard"},{name:"tel"},{name:"mobile"},{name:"address"},{name:"department"},{name:"headShip"},{name:"popedom"},{name:"password1"},{name:"is_manager"}],validations:[{type:"length",field:"code",min:1},{type:"length",field:"password1",min:1},{type:"length",field:"name",min:1}]});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TEmployee",pageSize:25,storeId:"EmployeeStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/employee.do?action=save",read:location.context+"/employee.do?action=list",update:location.context+"/employee.do?action=update",destroy:location.context+"/employee.do?action=del"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},
actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){a=eval("("+b.responseText+")");switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示",Ext.util.Format.trim(a.msg));break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}},listeners:{add:function(){Ext.data.StoreManager.lookup("EmployeeAllStore").load()},update:function(){Ext.data.StoreManager.lookup("EmployeeAllStore").load()},remove:function(){Ext.data.StoreManager.lookup("EmployeeAllStore").load()}}});
Ext.create("Ext.data.Store",{autoLoad:!0,autoSync:!0,model:"WJM.model.TEmployee",storeId:"EmployeeAllStore",pageSize:1E3,proxy:{batchActions:!0,pageParam:"currpage",limitParam:"pagesize",type:"ajax",api:{create:location.context+"/employee.do?action=save",read:location.context+"/employee.do?action=list",update:location.context+"/employee.do?action=update",destroy:location.context+"/employee.do?action=del"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},
actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){a=eval("("+b.responseText+")");switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示",Ext.util.Format.trim(a.msg));break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});
Ext.define("WJM.model.TPower",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"power_name"}],validations:[{type:"length",field:"power_name",min:1}],hasMany:{model:"WJM.model.TPowerOperation",name:"operations"},proxy:{batchActions:!0,type:"ajax",url:location.context+"/power.do?action=get",reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,
buttons:Ext.Msg.OK})}}}});
Ext.create("Ext.data.Store",{autoLoad:!0,autoSync:!0,model:"WJM.model.TPower",pageSize:200,storeId:"PowerStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/power.do?action=save",read:location.context+"/power.do?action=list",update:location.context+"/power.do?action=update",destroy:location.context+"/power.do?action=del"},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",
totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.define("WJM.model.TPowerOperation",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"popedomCode"},{name:"operationCode"}],validations:[{type:"length",field:"power_name",min:1}],belongsTo:"WJM.model.TPower"});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TPowerOperation",pageSize:25,storeId:"PowerOperationStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/power_opration.do?action=save",read:location.context+"/power_opration.do?action=list",update:location.context+"/power_opration.do?action=update",destroy:location.context+"/power_opration.do?action=del"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",
totalProperty:"total",messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});
Ext.define("WJM.model.TProduct",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id"},{name:"product_id"},{name:"code"},{name:"product_name"},{name:"spec"},{name:"unit"},{name:"size"},{name:"weight"},{name:"upLimit"},{name:"downLimit"},{name:"price_income"},{name:"price_simgle"},{name:"drawing"},{name:"helpName"},{name:"myMemo"},{name:"drawing2"},{name:"drawing3"},{name:"drawing4"},{name:"drawing5"},{name:"drawing6"},{name:"drawing7"},{name:"drawing8"},{name:"drawing9"},{name:"sreserve1"},
{name:"sreserve2"},{name:"sreserve3"},{name:"freserve1"},{name:"freserve2"},{name:"freserve3"},{name:"product_type"},{name:"num"},{name:"product_name_cn"},{name:"vendortName"},{name:"provider_id"},{name:"price_wholesale"},{name:"product_name_full",convert:function(a,b){return b.data.product_id+"--"+b.data.code+"--"+b.data.product_name+"--"+b.data.product_name_cn}},{name:"agio"},{name:"agio_price"}],validations:[{type:"length",field:"product_name",min:1}]});
Ext.define("WJM.model.ProductBaseStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!0,model:"WJM.model.TProduct",storeId:"ProductStore",pageSize:25,proxy:{batchActions:!0,pageParam:"currpage",limitParam:"pagesize",type:"ajax",api:{create:location.context+"/product.do?action=save",read:location.context+"/product.do?action=list",update:location.context+"/product.do?action=update",destroy:location.context+"/product.do?action=deleteProducts"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",
totalProperty:"total",messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示","保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});Ext.create("WJM.model.ProductBaseStore",{});
Ext.create("WJM.model.ProductBaseStore",{storeId:"ProductQuickStore",autoSync:!1,proxy:{batchActions:!0,pageParam:"currpage",limitParam:"pagesize",type:"ajax",api:{create:"",read:location.context+"/product.do?action=quickSearch",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示",
"保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});
Ext.create("WJM.model.ProductBaseStore",{storeId:"ProductAlertStore",autoSync:!1,proxy:{batchActions:!0,pageParam:"currpage",limitParam:"pagesize",type:"ajax",api:{create:"",read:location.context+"/product.do?action=listStoreAlert",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示",
"保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});Ext.define("WJM.model.TProductCategory",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id"},{name:"product_type_name"},{name:"product_type_name_cn"},{name:"code"},{name:"parent_id"},{name:"level"},{name:"parent_product_type_name"}],validations:[{type:"length",field:"product_type_name",min:1}]});
Ext.define("WJM.model.ProductCategoryBaseStore",{extend:"Ext.data.TreeStore",autoLoad:!1,autoSync:!0,model:"WJM.model.TProductCategory",storeId:"ProductCategoryStore",root:{product_type_name:"全部类别",level:0,expanded:!0,id:0},proxy:{batchActions:!0,type:"ajax",api:{create:location.context+"/product_type.do?action=save",read:location.context+"/product_type.do?action=list",update:location.context+"/product_type.do?action=update",destroy:location.context+"/product_type.do?action=del"},writer:Ext.create("WJM.FormWriter"),
reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示","保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});
Ext.define("WJM.model.ProductCategoryAllStore",{extend:"Ext.data.Store",autoLoad:!0,autoSync:!0,model:"WJM.model.TProductCategory",storeId:"ProductCategoryAllStore",proxy:{batchActions:!0,type:"ajax",api:{create:location.context+"/product_type.do?action=save",read:location.context+"/product_type.do?action=listall",update:location.context+"/product_type.do?action=update",destroy:location.context+"/product_type.do?action=del"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",
messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示","保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});Ext.create("WJM.model.ProductCategoryBaseStore",{});Ext.create("WJM.model.ProductCategoryAllStore",{});
Ext.define("WJM.model.TProductVendor",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id"},{name:"product_id"},{name:"vendor_id"},{name:"product_name"},{name:"vendor_name"},{name:"price"},{name:"useDefault"},{name:"useDefaultBoolean"}],proxy:{batchActions:!0,pageParam:"currpage",limitParam:"pagesize",type:"ajax",api:{create:"",read:"",update:"",destroy:location.context+"/productVendor.do?action=del"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},
actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示","保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});
Ext.define("WJM.model.ProductVendorBaseStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!1,model:"WJM.model.TProductVendor",storeId:"ProductVendorStore",proxy:{batchActions:!0,pageParam:"currpage",limitParam:"pagesize",type:"ajax",api:{create:"",read:location.context+"/productVendor.do?action=list",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},
listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示","保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});Ext.create("WJM.model.ProductVendorBaseStore",{});
Ext.define("WJM.model.TPurchase",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"if_stock"},{name:"if_stockStr",convert:function(a,b){if(0==b.data.if_stock)return"Non Received";if(1==b.data.if_stock)return"Received"}},{name:"oper_id"},{name:"oper_name"},{name:"oper_time"},{name:"cash_oper_id"},{name:"cash_oper_code"},{name:"cash_oper_name"},{name:"cash_time"},{name:"cash_station"},{name:"all_purchase_price"},{name:"all_paid_price"},{name:"purchase_bill_code"},{name:"provider_id"},
{name:"provider_name"},{name:"if_stock"},{name:"po_number"},{name:"order_pic"},{name:"invoice_code"},{name:"invoice_pic"},{name:"paid"},{name:"paidStr",convert:function(a,b){if(0==b.data.paid)return"Non Paid";if(1==b.data.paid)return"Paid"}},{name:"remark"},{name:"remark2"},{name:"actual_received"},{name:"receiver"},{name:"balance",convert:function(a,b){return b.data.all_paid_price-b.data.all_purchase_price}},{name:"actual_received_amount"}],hasMany:{model:"WJM.model.TPurchaseProduct",name:"products"},
canDelete:function(){return!(1==this.get("if_stock")||1==this.get("paid")||this.get("invoice_code")&&""!=this.get("invoice_code"))},canEdit:function(){return!(1==this.get("if_stock")||1==this.get("paid")||this.get("invoice_code")&&""!=this.get("invoice_code"))}});
Ext.define("WJM.model.PurchaseStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!0,model:"WJM.model.TPurchase",pageSize:25,storeId:"PurchaseStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/purchase_order.do?action=save",read:location.context+"/purchase_order.do?action=list",update:location.context+"/purchase_order.do?action=receivePurchase",destroy:location.context+"/purchase_order.do?action=del"},writer:Ext.create("WJM.FormWriter"),
actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.create("WJM.model.PurchaseStore",{});Ext.create("WJM.model.PurchaseStore",{storeId:"PurchaseMyStore"});Ext.create("WJM.model.PurchaseStore",{pageSize:10,storeId:"PurchaseVendorCashStore"});
Ext.create("Ext.data.Store",{fields:["value","name"],storeId:"PurchasePaidStateStore",data:[{value:"-1",name:"All"},{value:"0",name:"Non Paid"},{value:"1",name:"Paid"}]});Ext.create("Ext.data.Store",{fields:["value","name"],storeId:"PurchaseStockStateStore",data:[{value:"-1",name:"All"},{value:"0",name:"Non Received"},{value:"1",name:"Received"}]});
Ext.create("Ext.data.Store",{fields:["value","name"],storeId:"PurchaseCacheMethodStore",data:[{value:"Cash",name:"Cash/现金"},{value:"Check",name:"Check/支票"},{value:"Account Balance",name:"Account Balance/账户余额"}]});Ext.define("WJM.model.TPurchaseCashHistory",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"invoice_id"},{name:"amout"},{name:"payDate"},{name:"payment"},{name:"payDateForDB",convert:function(a){return Ext.Date.format(new Date(a),"Y-m-d")}},{name:"remark"}]});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!1,model:"WJM.model.TPurchaseCashHistory",pageSize:200,storeId:"PurchaseCashHistoryStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/invoice.do?action=",read:location.context+"/invoice.do?action=detail",update:location.context+"/invoice.do?action=",destroy:location.context+"/invoice.do?action="},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",
destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});
Ext.define("WJM.model.TPurchaseProduct",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"purchase_id"},{name:"product_id"},{name:"product_code"},{name:"product_name"},{name:"product_price"},{name:"product_num"},{name:"purchase_time"},{name:"provider_id"},{name:"provider_name"},{name:"remark"},{name:"if_stock"},{name:"actual_received"},{name:"receiver"},{name:"receive_num"},{name:"sub_total",convert:function(a,b){return b.data.product_price*b.data.product_num}}]});
Ext.define("WJM.model.PurchaseProductStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!1,model:"WJM.model.TPurchaseProduct",pageSize:25,storeId:"PurchaseProductStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:"",read:location.context+"/purchase_product.do?action=list",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},
listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.create("WJM.model.PurchaseProductStore",{});Ext.create("WJM.model.PurchaseProductStore",{storeId:"PurchaseProductMyStore"});Ext.create("WJM.model.PurchaseProductStore",{storeId:"PurchaseProductVendorCashStore"});
Ext.define("WJM.model.TSale",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"oper_id"},{name:"sale_bill_code"},{name:"if_cashed"},{name:"if_cashedStr",convert:function(a,b){if(0==b.data.if_cashed)return"Processing(Non pay)";if(1==b.data.if_cashed)return"Paid";if(2==b.data.if_cashed)return"RMA"}},{name:"oper_code"},{name:"oper_name"},{name:"oper_time"},{name:"cash_oper_id"},{name:"cash_oper_code"},{name:"cash_oper_name"},{name:"cash_time"},{name:"cash_station"},{name:"rma_id"},
{name:"rma_time"},{name:"rma_code"},{name:"rma_name"},{name:"tax"},{name:"payment"},{name:"all_price"},{name:"sub_total"},{name:"discount"},{name:"buyer_id"},{name:"buyer_code"},{name:"buyer_name"},{name:"buyer_address"},{name:"buyer_state"},{name:"buyer_city"},{name:"buyer_mobile"},{name:"buyer_postCode"},{name:"confirm_code"},{name:"invoice"},{name:"remark"},{name:"paid_price"},{name:"send_type"},{name:"send_time"},{name:"send_operid"},{name:"send_opername"},{name:"balance",convert:function(a,b){return b.data.paid_price-
b.data.all_price}}],hasMany:{model:"WJM.model.TSaleProduct",name:"products"},canDelete:function(){return 0==this.get("if_cashed")?!0:!1},canEdit:function(){return 0==this.get("if_cashed")?!0:!1},isRma:function(){return 2==this.get("if_cashed")?!0:!1}});
Ext.define("WJM.model.SaleStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!0,model:"WJM.model.TSale",pageSize:25,storeId:"SaleStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",extraParams:{type:0},api:{create:location.context+"/sale.do?action=save",read:location.context+"/sale.do?action=list",update:location.context+"/sale.do?action=update",destroy:location.context+"/sale.do?action=del"},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",
update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.create("WJM.model.SaleStore",{});Ext.create("WJM.model.SaleStore",{storeId:"SaleRmaStore"});Ext.create("WJM.model.SaleStore",{storeId:"SaleMyStore"});Ext.create("WJM.model.SaleStore",{storeId:"SaleCustomerCashStore"});
Ext.create("WJM.model.SaleStore",{storeId:"SaleMyQuoteStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",extraParams:{type:1},api:{create:location.context+"/sale.do?action=save",read:location.context+"/sale.do?action=list",update:location.context+"/sale.do?action=update",destroy:location.context+"/sale.do?action=del"},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",
messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.create("Ext.data.Store",{fields:["value","name"],storeId:"SaleCashStateStore",data:[{value:"-1",name:"All"},{value:"0",name:"Processing(Non pay)"},{value:"1",name:"Paid"},{value:"2",name:"RMA"}]});
Ext.create("Ext.data.Store",{fields:["value","name"],storeId:"SalePaymentMethodStore",data:[{value:"Cash",name:"Cash/现金"},{value:"Credit Card",name:"Credit Card/信用卡"},{value:"Credit Account",name:"Credit Account/会员"}]});Ext.create("Ext.data.Store",{fields:["value","name"],storeId:"SaleCacheMethodStore",data:[{value:"Cash",name:"Cash/现金"},{value:"Check",name:"Check/支票"},{value:"Deposit",name:"Deposit/预付款"}]});
Ext.create("Ext.data.Store",{fields:["value","name"],storeId:"SaleSendMethodStore",data:[{value:"送货",name:"送货"},{value:"邮寄",name:"邮寄"},{value:"自取",name:"自取"}]});
Ext.define("WJM.model.TSaleCashHistory",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"oper_id"},{name:"buyer_id"},{name:"cash_time"},{name:"amount"},{name:"sale_id"},{name:"sale_bill_code"},{name:"oper_name"},{name:"buyer_name"},{name:"remark"},{name:"payment"},{name:"payDate",convert:function(a,b){return Ext.Date.format(new Date(b.data.cash_time.time),"Y-m-d")}}]});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!1,model:"WJM.model.TSaleCashHistory",pageSize:200,storeId:"SaleCashHistoryStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/invoice.do?action=",read:location.context+"/sale.do?action=listSaleCash",update:location.context+"/invoice.do?action=",destroy:location.context+"/invoice.do?action="},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},
reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});
Ext.define("WJM.model.TSaleProduct",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"sale_id"},{name:"product_id"},{name:"productid"},{name:"product_code"},{name:"code",convert:function(a,b){return b.data.product_code}},{name:"product_name"},{name:"product_price"},{name:"agio"},{name:"agio_price"},{name:"product_num"},{name:"sale_time"},{name:"rma_id"},{name:"rma_time"},{name:"rma_code"},{name:"rma_num"},{name:"if_rma"},{name:"if_back_order"},{name:"back_order_id"},
{name:"back_order_time"},{name:"back_order_code"},{name:"credit_num"},{name:"damage_num"},{name:"return_credit_num"},{name:"return_damage_num"},{name:"sub_total",convert:function(a,b){return b.data.product_price*b.data.product_num}},{name:"sub_total2",convert:function(a,b){return b.data.agio_price*b.data.product_num}}]});
Ext.define("WJM.model.SaleProductStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!1,model:"WJM.model.TSaleProduct",pageSize:25,storeId:"SaleProductStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:"",read:location.context+"/sale_product.do?action=list",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},
listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.create("WJM.model.SaleProductStore",{});Ext.create("WJM.model.SaleProductStore",{storeId:"SaleProductRmaStore"});Ext.create("WJM.model.SaleProductStore",{storeId:"SaleProductMyStore"});Ext.create("WJM.model.SaleProductStore",{storeId:"SaleQuoteProductMyStore"});
Ext.define("WJM.model.TSaleTop",{extend:"Ext.data.Model",idProperty:"product_name",fields:[{name:"product_name"},{name:"all_price"},{name:"sale_times"}]});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TSaleTop",storeId:"SaleTopDayStore",proxy:{batchActions:!0,type:"ajax",api:{create:"",read:location.context+"/sale.do?action=day_stat",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,
buttons:Ext.Msg.OK})}}}});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TSaleTop",storeId:"SaleTopMonthStore",proxy:{batchActions:!0,type:"ajax",api:{create:"",read:location.context+"/sale.do?action=month_stat",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",
icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TSaleTop",storeId:"SaleTopBetweenStore",proxy:{batchActions:!0,type:"ajax",api:{create:"",read:location.context+"/sale.do?action=between_stat",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",
icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.define("WJM.model.TStock",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"stock_bill_code"},{name:"oper_id"},{name:"oper_name"},{name:"oper_time"},{name:"all_stock_price"},{name:"provider_id"},{name:"provider_name"}],hasMany:{model:"WJM.stock.TStockProduct",name:"products"}});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TStock",pageSize:25,storeId:"StockStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/stock.do?action=save",read:location.context+"/stock.do?action=list",update:location.context+"/stock.do?action=update",destroy:location.context+"/stock.do?action=del"},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",
totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.define("WJM.model.TStockAndProduct",{extend:"Ext.data.Model",idProperty:"product_id",fields:[{name:"product_id"},{name:"product_type"},{name:"product_price"},{name:"product_name"},{name:"code"},{name:"stock_time",type:"string"}]});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TStockAndProduct",storeId:"StockAndProductStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:"",read:location.context+"/stock_and_product.do?action=query",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,
b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});Ext.define("WJM.model.TStockProduct",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id",type:"float"},{name:"stock_id"},{name:"product_id"},{name:"product_code"},{name:"product_name"},{name:"product_price"},{name:"product_num"},{name:"stock_time"},{name:"provider_id"},{name:"provider_name"}]});
Ext.create("Ext.data.Store",{autoLoad:!1,autoSync:!0,model:"WJM.model.TStockProduct",pageSize:25,storeId:"StockProductStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:"",read:location.context+"/stock_product.do?action=list",update:"",destroy:""},writer:Ext.create("WJM.FormWriter"),actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,
b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}}}});
Ext.define("WJM.model.TVendor",{extend:"Ext.data.Model",idProperty:"id",fields:[{name:"id"},{name:"type"},{name:"code"},{name:"shortName"},{name:"allName"},{name:"address"},{name:"postCode"},{name:"tel1"},{name:"tel2"},{name:"tel3"},{name:"mobile"},{name:"FAX"},{name:"EMail"},{name:"http"},{name:"accounts"},{name:"taxCode"},{name:"linkMan"},{name:"companyType"},{name:"helpName"},{name:"recDate"},{name:"myMemo"},{name:"state"},{name:"city"},{name:"sreserve3"},{name:"freserve1"},{name:"freserve2"},
{name:"freserve3"},{name:"balance"},{name:"invoice_total"},{name:"invoice_balance"},{name:"paid_total",convert:function(a,b){return b.data.invoice_total-b.data.invoice_balance}},{name:"acc_balance"}],validations:[{type:"length",field:"shortName",min:1}],proxy:{batchActions:!0,type:"ajax",url:location.context+"/power.do?action=get",reader:{root:"listData",totalProperty:"total",messageProperty:"msg"},listeners:{exception:function(a,b,c){Ext.MessageBox.show({title:"操作失败",msg:c.getError()||"操作失败",icon:Ext.MessageBox.ERROR,
buttons:Ext.Msg.OK})}}}});
Ext.define("WJM.model.VendorBaseStore",{extend:"Ext.data.Store",autoLoad:!1,autoSync:!0,model:"WJM.model.TVendor",pageSize:25,storeId:"VendorStore",proxy:{batchActions:!0,type:"ajax",pageParam:"currpage",limitParam:"pagesize",api:{create:location.context+"/provider.do?action=save",read:location.context+"/provider.do?action=list",update:location.context+"/provider.do?action=update",destroy:location.context+"/provider.do?action=del"},writer:Ext.create("WJM.FormWriter"),reader:{root:"listData",totalProperty:"total",
messageProperty:"msg"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},listeners:{exception:function(a,b,c){switch(c.action){case "create":case "update":Ext.MessageBox.alert("提示","保存失败，请稍后重试");break;case "destroy":Ext.MessageBox.alert("提示","删除失败，请稍后重试")}}}}});Ext.create("WJM.model.VendorBaseStore",{storeId:"VendorSearchStore"});
Ext.define("WJM.admin.BackUpModel",{extend:"Ext.ux.desktop.Module",id:"backup",init:function(){this.id=this.config.moduleId||"backup";this.title=this.config.menuText||"setting/设置"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);if(!b)var b=Ext.create("Ext.panel.Panel",{title:"备份",layout:{type:"vbox",align:"center",padding:10},items:[{xtype:"label",html:'<span style="font-size: 20px;color: red;">Please backup database every week!</span>'},{xtype:"button",text:'<span style="font-size: 20px;">backup</span>',
scale:"large",margin:"30 0 0 0",scope:this,handler:this.onBackupClick}]}),c=Ext.create("WJM.admin.CompanyForm"),b=a.createWindow({id:this.id,title:this.title,width:400,height:400,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:{xtype:"tabpanel",items:[c,b]}});return b},onBackupClick:function(){(new Ext.data.proxy.Ajax({url:"setting.do?action=backupdatabase",reader:new Ext.data.reader.Json({type:"json",messageProperty:"msg",model:"WJM.model.TPurchase"}),writer:Ext.create("WJM.FormWriter")})).read(new Ext.data.Operation({}),
function(a){Ext.Msg.alert("提示","备份成功，备份到"+a.resultSet.message);this.app.getDesktop().getWindow(this.id).destroy()},this)}});
Ext.define("WJM.admin.CompanyForm",{extend:"Ext.form.Panel",requires:["WJM.model.TCompany"],title:"公司",record:null,closeAction:"destroy",autoScroll:!0,bodyPadding:10,initComponent:function(){var a=this;Ext.applyIf(a,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"company_name",fieldLabel:"company name/公司名称"},{name:"company_address",fieldLabel:"company address/公司地址"},{name:"company_tel",fieldLabel:"company tel/公司电话"},{name:"company_fax",fieldLabel:"company fax/公司传真"},{name:"invoiceTax",
fieldLabel:"Invoice Tax/订单税率",xtype:"numberfield",decimalPrecision:5},{xtype:"image",src:"",id:"image1"},{xtype:"filefield",name:"theFile",fieldLabel:"company name logo/公司名称",allowBlank:!0,anchor:"100%",buttonText:"选择图片"},{xtype:"image",src:"",id:"image2",maxWidth:"100"},{xtype:"filefield",name:"theFile2",fieldLabel:"company logo/公司图标",allowBlank:!0,anchor:"100%",buttonText:"选择图片"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick}]}]});
a.callParent(arguments);WJM.model.TCompany.load(10,{scope:a,success:function(b){this.record=b;a.loadRecord(this.record);a.getComponent("image1").setSrc(location.context+this.record.get("company_name_pic_logo"));a.getComponent("image2").setSrc(location.context+this.record.get("company_logo_pic_logo"))}})},onSaveClick:function(){var a=this;this.getForm().isValid()&&this.submit({url:"setting.do?action=saveCompany",success:function(){Ext.Msg.alert("提示","保存成功");a.fireEvent("saveSuccess",a)},failure:function(){Ext.Msg.alert("提示",
"保存失败，请稍候重试")}})}});
Ext.define("WJM.cash.CashierModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSale","WJM.model.TSaleProduct"],id:"cash",init:function(){this.id=this.config.moduleId||"cash";this.title=this.config.menuText||"cashier/支付"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);if(!b)var b=Ext.create("WJM.sale.SaleGrid",{title:"sale",deleteAble:!0,cashAble:!0,reciveAble:!0}),c=Ext.create("WJM.purchase.PurchaseGrid",{title:"purchase",deleteAble:!0,cashAble:!0}),b=a.createWindow({id:this.id,
title:this.title,width:980,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:{xtype:"tabpanel",items:[b,c]}});return b}});
Ext.define("WJM.cash.PurchaseCashForm",{extend:"Ext.form.Panel",closeAction:"destroy",record:null,bodyPadding:10,initComponent:function(){Ext.applyIf(this,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},{name:"invoice_code",xtype:"hiddenfield"},{name:"purchase_bill_code",fieldLabel:"P.O. #/定单号",readOnly:!0},{name:"oper_name",fieldLabel:"buyman/采购员",readOnly:!0},{name:"oper_time",fieldLabel:"buy time/采购时间",readOnly:!0},{name:"code",fieldLabel:"casher/收银员",
value:window.user.userName,readOnly:!0},{name:"cash_time",fieldLabel:"cash time/收银时间",value:Ext.Date.format(new Date,"Y-m-d H:i:s"),readOnly:!0},{name:"all_purchase_price",fieldLabel:"total/合计",minValue:0,xtype:"adnumberfield",readOnly:!0},{name:"balance",fieldLabel:"balance/余额",xtype:"adnumberfield",readOnly:!0},{name:"paidAmount",fieldLabel:"paid/金额",xtype:"adnumberfield",listeners:{change:this.calculateBalance,scope:this}},{xtype:"combobox",fieldLabel:"Payment Method/支付方式",labelWidth:170,name:"paymentMethod",
displayField:"name",valueField:"value",store:"PurchaseCacheMethodStore",value:"Cash",allowBlank:!1},{name:"remark",fieldLabel:"remark/备注",xtype:"textareafield",allowBlank:!0}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"确定付款",scope:this,handler:this.onSaveClick}]}]});this.callParent(arguments);this.record&&(this.loadRecord(this.record),this.getForm().findField("paidAmount").setValue(-this.record.get("balance")),this.getForm().findField("cash_time").setValue(Ext.Date.format(new Date,
"Y-m-d H:i:s")));this.getForm().findField("paidAmount").focus()},onSaveClick:function(){var a=this;this.getForm().isValid()&&this.submit({url:"invoice.do?action=payInvoice",success:function(){Ext.Msg.alert("提示","保存成功");a.fireEvent("saveSuccess",a)},failure:function(a,c){Ext.Msg.alert("提示",c.result.msg||"保存失败，请稍候重试")}})},calculateBalance:function(){this.getForm().findField("balance").setValue(-this.record.get("balance")-this.getForm().findField("paidAmount").getValue())}});
Ext.define("WJM.cash.SaleCashForm",{extend:"Ext.form.Panel",closeAction:"destroy",record:null,bodyPadding:10,initComponent:function(){Ext.applyIf(this,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},{name:"sale_bill_code",fieldLabel:"receive #/销售单号",readOnly:!0},{name:"oper_name",fieldLabel:"saleman/销售员",readOnly:!0},{name:"oper_time",fieldLabel:"sale time/销售时间",readOnly:!0},{name:"code",fieldLabel:"casher/收银员",value:window.user.userName,readOnly:!0},
{name:"cash_time",fieldLabel:"cash time/收银时间",value:Ext.Date.format(new Date,"Y-m-d H:i:s"),readOnly:!0},{name:"all_price",fieldLabel:"total/合计",minValue:0,xtype:"adnumberfield",readOnly:!0},{name:"balance",fieldLabel:"balance/余额",xtype:"adnumberfield",readOnly:!0},{name:"accept",fieldLabel:"paid/金额",xtype:"adnumberfield",listeners:{change:this.calculateBalance,scope:this}},{name:"remark",fieldLabel:"remark/备注",xtype:"textareafield",allowBlank:!0}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",
iconCls:"save",text:"确定收款",scope:this,handler:this.onSaveClick}]}]});this.callParent(arguments);this.record&&(this.loadRecord(this.record),this.getForm().findField("accept").setValue(-this.record.get("balance")),this.getForm().findField("cash_time").setValue(Ext.Date.format(new Date,"Y-m-d H:i:s")));this.getForm().findField("accept").focus(!0,!0)},onSaveClick:function(){var a=this;this.getForm().isValid()&&this.submit({url:"sale.do?action=cash_submit",success:function(){Ext.Msg.alert("提示","保存成功");
a.fireEvent("saveSuccess",a)},failure:function(a,c){Ext.Msg.alert("提示",c.result.msg||"保存失败，请稍候重试")}})},calculateBalance:function(){this.getForm().findField("balance").setValue(-this.record.get("balance")-this.getForm().findField("accept").getValue())}});
Ext.define("WJM.cash.widget.PurchaseCashGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],layout:{type:"border",padding:5},defaults:{split:!0},purchaseStore:"PurchaseStore",cashStore:"PurchaseCashHistoryStore",initComponent:function(){var a=[{iconCls:"search",text:"打印",scope:this,handler:this.onSalePrintClick}];a.push({iconCls:"edit",text:"添加账单",scope:this,handler:this.onAddInvoiceClick},{iconCls:"edit",text:"付款",scope:this,handler:this.onCashClick});this.editTopBar=Ext.create("Ext.toolbar.Toolbar",
{items:a});Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{store:this.purchaseStore,split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",title:"采购单",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"P.O. #/定单号",dataIndex:"purchase_bill_code",sortable:!0},{text:"Work ID/操作员",dataIndex:"oper_name",sortable:!0},{text:"vendor name/供货商",dataIndex:"provider_name",sortable:!0},{text:"total/总计",dataIndex:"all_purchase_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},
{text:"actual received amount/完成货总额",dataIndex:"actual_received_amount",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"Invoice/账单",dataIndex:"invoice_code",sortable:!0},{text:"P.O. balance/订单余额",dataIndex:"balance",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"received status/收货状态",dataIndex:"if_stockStr",sortable:!0},{text:"payment status/付款状态",dataIndex:"paidStr",sortable:!0},{text:"date/时间",dataIndex:"oper_time",sortable:!0}],viewConfig:{plugins:[]},listeners:{selectionchange:function(a){if(a=
a.getSelection()[0]){var c=Ext.data.StoreManager.lookup(this.cashStore);c.getProxy().setExtraParam("provider_id",a.get("provider_id"));c.getProxy().setExtraParam("purchase_bill_code",a.get("purchase_bill_code"));c.load()}},scope:this},bbar:Ext.create("Ext.PagingToolbar",{store:this.purchaseStore,displayInfo:!0,displayMsg:"显示采购单 {0} - {1} 总共 {2}",emptyMsg:"没有采购单数据"})},{store:this.cashStore,split:!0,disableSelection:!1,collapsible:!0,split:!0,loadMask:!0,height:150,autoScroll:!0,region:"south",multiSelect:!0,
title:"账单付款明细",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"amount/付款金额",dataIndex:"amout",sortable:!0},{text:"date/时间",dataIndex:"payDateForDB",sortable:!0},{text:"payment/支付方式",dataIndex:"payment",sortable:!0},{text:"remark/备注",dataIndex:"remark",sortable:!0,width:200}],viewConfig:{plugins:[]},plugins:[]}]});this.callParent()},onCashClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];if(a)if(0==a.get("paid"))if(a.get("invoice_code")&&
""!=a.get("invoice_code")){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.cash.PurchaseCashForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"付款",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","请先为此订单添加账单");else Ext.Msg.alert("提示","此采购单已经付款");else Ext.Msg.alert("提示","请选择采购单")},onAddInvoiceClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];
if(a)if(!a.get("invoice_code")||""==a.get("invoice_code")){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.purchase.PurchaseInvoiceForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"添加账单",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","此订单已经添加了账单");else Ext.Msg.alert("提示","请选择采购单")},onSalePrintClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];
a?window.open(location.context+"/purchase_order.do?action=print_bill&id="+a.getId(),"_blank"):Ext.Msg.alert("提示","请选择采购单")},onSaveSuccess:function(a){a.ownerCt.destroy();Ext.data.StoreManager.lookup(this.purchaseStore).loadPage(1);this.show();this.fireEvent("saveSuccess")}});
Ext.define("WJM.cash.widget.SaleCashGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel","WJM.model.TSaleCashHistory"],collapsedStatistics:!1,layout:{type:"border",padding:5},defaults:{split:!0},customer:null,saleStore:"SaleStore",saleCashHistoryStore:"SaleCashHistoryStore",initComponent:function(){var a=[{iconCls:"search",text:"打印订单",scope:this,handler:this.onSalePrintClick}];a.push({iconCls:"search",text:"打印出货单",scope:this,handler:this.onPackePrintClick});a.push({iconCls:"edit",text:"批量收款",
scope:this,handler:this.onCashGridClick},{text:"按住control键多选",xtype:"label"});this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:a});Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{store:this.saleStore,split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",multiSelect:!0,title:"订单",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"receive #/销售单",dataIndex:"sale_bill_code",sortable:!0},{text:"invoice #/invoice单号",dataIndex:"invoice",sortable:!0},{text:"saleman/销售员",
dataIndex:"oper_name",sortable:!0},{text:"customer/客户",dataIndex:"buyer_name",sortable:!0},{text:"total/合计",dataIndex:"all_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"invoice balance/账单余额",dataIndex:"balance",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"state/状态",dataIndex:"if_cashedStr",sortable:!0},{text:"date/时间",dataIndex:"oper_time",sortable:!0},{text:"tax/税",dataIndex:"tax",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"payment/支付方式",dataIndex:"payment",
sortable:!0},{text:"sub total/小计",dataIndex:"sub_total",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"discount/优惠",dataIndex:"discount",sortable:!0,xtype:"numbercolumn",format:"$0.00"}],viewConfig:{plugins:[]},listeners:{selectionchange:function(a){if(a=a.getSelection()[0]){var c=Ext.data.StoreManager.lookup(this.saleCashHistoryStore);c.getProxy().setExtraParam("id",a.getId());c.load()}},scope:this},bbar:Ext.create("Ext.PagingToolbar",{store:this.saleStore,displayInfo:!0,displayMsg:"显示订单 {0} - {1} 总共 {2}",
emptyMsg:"没有订单数据"})},{region:"south",store:this.saleCashHistoryStore,split:!0,disableSelection:!1,collapsible:!0,split:!0,loadMask:!0,height:150,autoScroll:!0,multiSelect:!0,title:"收款明细",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"amount/收款金额",dataIndex:"amount",sortable:!0},{text:"date/时间",dataIndex:"payDate",sortable:!0},{text:"payment/支付方式",dataIndex:"payment",sortable:!0},{text:"remark/备注",dataIndex:"remark",sortable:!0,width:200}]}]});this.callParent()},onCashClick:function(){var a=
this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];if(a)if(0==a.get("if_cashed")){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.cash.SaleCashForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"收款",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","此订单已经收款");else Ext.Msg.alert("提示","请选择订单")},onCashGridClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection();
if(a[0]){var b=[];Ext.Array.each(a,function(a){0==a.get("if_cashed")&&(a=Ext.create("WJM.model.TSale",a.getData()),b.push(a))});if(0<b.length){var a=myDesktopApp.getDesktop(),c=Ext.create("WJM.cash.widget.SaleCashGridForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},records:b,customer:this.customer});win=a.createWindow({title:"批量收款",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[c]});win.show()}else Ext.Msg.alert("提示","没有未收款的订单！")}else Ext.Msg.alert("提示","请选择订单")},
onSaveSuccess:function(a){a.ownerCt.destroy();Ext.data.StoreManager.lookup(this.saleStore).loadPage(1);this.show();this.fireEvent("saveSuccess")},onSalePrintClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];a?window.open(location.context+"/sale.do?action=re_print&id="+a.getId(),"_blank"):Ext.Msg.alert("提示","请选择订单")},onPackePrintClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];a?0==a.get("if_cashed")?
Ext.Msg.alert("提示","此订单未完全收款，无法打印出货单"):window.open(location.context+"/sale.do?action=packing_print&id="+a.getId(),"_blank"):Ext.Msg.alert("提示","请选择订单")},setCustomer:function(a){this.customer=a;var b=Ext.data.StoreManager.lookup(this.saleStore);b.getProxy().setExtraParam("buyer_id",a.getId());b.load()}});
Ext.define("WJM.cash.widget.SaleCashGridForm",{extend:"Ext.form.Panel",records:null,customer:null,bodyPadding:10,closeAction:"destroy",initComponent:function(){var a=this;a.allTotal=0;Ext.Array.each(this.records,function(b){b.set("paid_price_old",b.get("paid_price"));b.set("balance_old",b.get("balance"));a.allTotal+=b.get("balance")});a.allTotal=-a.allTotal;this.recordStore=Ext.create("Ext.data.Store",{model:"WJM.model.TSale"});this.recordStore.loadRecords(this.records);this.editor=Ext.create("Ext.grid.plugin.CellEditing",
{clicksToEdit:1,listeners:{edit:a.calculateTotal,scope:a}});Ext.applyIf(a,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{xtype:"container",layout:{columns:2,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"50%"}}},items:[{name:"totalbalance",fieldLabel:"total invoice balance/总余额",xtype:"adnumberfield",allowBlank:!1,readOnly:!0,value:this.allTotal},{name:"allaccept",fieldLabel:"paid/收款金额",xtype:"adnumberfield",allowBlank:!1,enableKeyEvents:!0,minValue:0,value:a.allTotal,
listeners:{keyup:a.calculateBalance,scope:a}},{xtype:"combobox",fieldLabel:"Payment Method/支付方式",labelWidth:170,name:"payment",displayField:"name",valueField:"value",store:"SaleCacheMethodStore",value:"Cash",allowBlank:!1,listeners:{select:a.onPayMentSelect,scope:a}},{name:"allbalance",fieldLabel:"balance/总余额",xtype:"adnumberfield",allowBlank:!1,readOnly:!0},{width:"100%",rows:2,name:"remark",fieldLabel:"remark/备注",xtype:"textareafield",allowBlank:!0,labelWidth:110,anchor:"100%"}]},{xtype:"container",
layout:{columns:1,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"100%"}}},items:[]},{store:this.recordStore,disableSelection:!1,loadMask:!0,autoScroll:!0,title:"收款订单列表",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{dataIndex:"sale_bill_code",text:"receive #/销售单号"},{dataIndex:"oper_name",text:"saleman/销售员"},{dataIndex:"cash_time",text:"cash time/收银时间"},{dataIndex:"all_price",text:"total/合计",minValue:0,xtype:"numbercolumn",format:"$0.00"},{dataIndex:"balance_old",text:"invoice balance/订单余额",
minValue:0,xtype:"numbercolumn",format:"$0.00"},{dataIndex:"balance",text:"balance/余额",xtype:"numbercolumn",format:"$0.00"},{dataIndex:"accept",text:"paid/金额",xtype:"numbercolumn",format:"$0.00",editor:{xtype:"adnumberfield",allowBlank:!1,minValue:0}}],plugins:[this.editor]}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"确定收款",scope:this,handler:this.onSaveClick}]}]});a.callParent(arguments);a.calculateBalance()},onSaveClick:function(){var a=this.getForm(),b=
this,c=[];this.recordStore.data.each(function(a){c.push(a.data)});a.isValid()&&this.submit({url:"sale.do?action=cashs_submit",params:{saleCashs:Ext.JSON.encode(c)},success:function(){Ext.Msg.alert("提示","保存成功");b.fireEvent("saveSuccess",b)},failure:function(a,b){Ext.Msg.alert("提示",b.result.msg||"保存失败，请稍候重试")}})},calculateTotal:function(){var a=0;this.recordStore.data.each(function(b){b.set("paid_price",b.get("paid_price_old")+b.get("accept"));b.set("balance",0);a+=b.get("accept")});this.getForm().findField("allaccept").setValue(a);
this.getForm().findField("allbalance").setValue(a-this.allTotal)},calculateBalance:function(){var a=this.getForm().findField("allaccept").getValue();this.getForm().findField("allbalance").setValue(a-this.allTotal);this.recordStore.data.each(function(b){a>-b.get("balance_old")?b.set("accept",-b.get("balance_old")):b.set("accept",a);b.set("paid_price",b.get("paid_price_old")+b.get("accept"));b.set("balance",0);a-=b.get("accept")})},onPayMentSelect:function(a){"Deposit"==a.getValue()&&(this.getForm().findField("allaccept").setValue(this.customer.get("leav_money")),
this.calculateBalance())}});
Ext.define("WJM.customer.CustomerForm",{extend:"Ext.form.Panel",closeAction:"destroy",record:null,height:600,width:492,bodyPadding:10,initComponent:function(){Ext.applyIf(this,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},{name:"recDate",xtype:"hiddenfield",value:Ext.Date.format(new Date,"Y-m-d H:i:s")},{name:"code",fieldLabel:"Customer Code/客户代码",labelWidth:150,allowBlank:!1},{name:"shortName",fieldLabel:"Customer Name/客户名字",allowBlank:!1},{name:"address",
fieldLabel:"Address/地址"},{name:"city",fieldLabel:"City/城市"},{name:"state",fieldLabel:"State/州"},{name:"postCode",fieldLabel:"Zip Code/邮编"},{name:"mobile",fieldLabel:"Phone/电话"},{name:"FAX",fieldLabel:"Fax/传真"},{name:"linkMan",fieldLabel:"Contact Person/联系人"},{name:"taxCode",fieldLabel:"Tax Id/税号"},{name:"EMail",fieldLabel:"Email/电子邮件"},{name:"http",fieldLabel:"Website/网址"},{name:"bank_Name",fieldLabel:"Bank Name/银行"},{name:"bank_Acount",fieldLabel:"Bank Acount/银行帐号"},{name:"leav_money",fieldLabel:"deposit/预付金额",
xtype:"adnumberfield"},{name:"credit_Line",fieldLabel:"Credit Line/信用金额",xtype:"adnumberfield"},{name:"myMemo",fieldLabel:"remark/注释",xtype:"textareafield"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick}]}]});this.on("afterrender",this.initDragDorp,this);this.callParent(arguments);this.record&&this.loadRecord(this.record)},initDragDorp:function(){var a=this;this.dragDorp=Ext.create("Ext.dd.DropTarget",this.getEl().dom,
{ddGroup:"TCustomer",notifyEnter:function(){a.stopAnimation();a.getEl().highlight()},notifyDrop:function(b){b=b.dragData.records[0];a.getForm().loadRecord(b);return!0}})},onSaveClick:function(){var a=this;this.getForm().isValid()&&this.submit({url:"buyer.do?action=save",success:function(){Ext.Msg.alert("提示","保存成功");a.fireEvent("saveSuccess",a)},failure:function(){Ext.Msg.alert("提示","保存失败，请稍候重试")}})},beforeDestroy:function(){Ext.destroy(this.dragDorp);this.callParent()}});
Ext.define("WJM.customer.CustomerGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel","WJM.model.TVendor","Ext.grid.plugin.RowEditing"],editAble:!1,cashAble:!1,height:487,width:569,layout:{type:"border",padding:5},defaults:{split:!0},initComponent:function(){this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"add",text:"添加",scope:this,handler:this.onAddClick},{iconCls:"edit",text:"编辑",scope:this,handler:this.onEditClick},
{iconCls:"remove",text:"删除",scope:this,handler:this.onDeleteClick}]});var a=[];a.push({anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"客户检索",layout:{columns:2,type:"table"},bodyPadding:10,items:[{xtype:"textfield",fieldLabel:"customer name/客户名字",labelWidth:150,name:"shortName"},{xtype:"textfield",fieldLabel:"contact person/联系人",labelWidth:150,name:"linkMan"},{xtype:"textfield",fieldLabel:"phone/电话",labelWidth:150,name:"mobile"}]},{store:"CustomerSearchStore",
split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"customer code/客户代码",dataIndex:"code",sortable:!0,width:150},{text:"customer name/客户名字",dataIndex:"shortName",sortable:!0,width:100},{text:"deposit/预付金额",dataIndex:"show_leav_money",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"Credit Line/信用金额",dataIndex:"credit_Line",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"account balance/帐号余额",dataIndex:"acc_balance",
sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"Outstanding Balance/未付金额",dataIndex:"balance",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"total/总消费额",dataIndex:"total",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"tax id/税号",dataIndex:"taxCode",sortable:!0,width:100},{text:"Contact Person/联系人",dataIndex:"linkMan",sortable:!0,width:100},{text:"phone/电话",dataIndex:"mobile",sortable:!0},{text:"Address/地址",dataIndex:"address",sortable:!0},{text:"remark/注释",dataIndex:"myMemo",
sortable:!0,flex:1}],viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop",ddGroup:"TCustomer",enableDrop:!1})]},bbar:Ext.create("Ext.PagingToolbar",{store:"CustomerSearchStore",displayInfo:!0,displayMsg:"显示 客户 {0} - {1} 总共 {2}",emptyMsg:"没有客户数据"}),listeners:{selectionchange:function(a){this.cashGrid&&(a=a.getSelection()[0])&&this.cashGrid.setCustomer(a)},scope:this}});this.cashAble&&(this.cashGrid=Ext.create("WJM.cash.widget.SaleCashGrid",{region:"south",title:"客户订单列表",
height:400,collapsed:!1,collapsible:!0,saleStore:"SaleCustomerCashStore",saleCashHistoryStore:"SaleCashHistoryStore"}),this.cashGrid.on("saveSuccess",this.onSaveSuccess,this),a.push(this.cashGrid));Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:a});Ext.data.StoreManager.lookup("CustomerSearchStore").loadPage(1);this.callParent()},onDeleteClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];a?Ext.Msg.confirm("提示","确定要删除此客户么？",function(b){"yes"==
b&&Ext.data.StoreManager.lookup("CustomerSearchStore").remove(a)},this):Ext.Msg.alert("提示","请选择客户")},onAddClick:function(){win=myDesktopApp.getDesktop().createWindow({title:"新建客户",height:680,width:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.customer.CustomerForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this}})]});win.show()},onEditClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];if(a){var b=myDesktopApp.getDesktop(),
c=Ext.create("WJM.customer.CustomerForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this}});win=b.createWindow({title:"编辑客户",height:680,width:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[c]});win.show();c.getForm().loadRecord(a)}else Ext.Msg.alert("提示","请选择客户")},onSaveSuccess:function(a){a&&(a=a.ownerCt)&&a.destroy();Ext.data.StoreManager.lookup("CustomerSearchStore").loadPage(1)},onSearchClick:function(){var a=this.down("form").getForm().getFieldValues(),b=
Ext.data.StoreManager.lookup("CustomerSearchStore");Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.loadPage(1)}});
Ext.define("WJM.customer.CustomerManageModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TCustomer"],id:"customer",init:function(){this.id=this.config.moduleId||"customer";this.title=this.config.menuText||"customer/客户"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.customer.CustomerGrid",{editAble:!0,cashAble:!0}),b=a.createWindow({id:this.id,title:this.title,width:900,height:800,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",
items:[b]}));return b}});
Ext.define("WJM.customer.CustomerQuickSearchForm",{extend:"Ext.form.Panel",requires:["WJM.model.TCustomer"],keyMapTarget:null,keyMap:null,initComponent:function(){Ext.apply(this,{bodyPadding:10,items:[{store:"CustomerQuickStore",xtype:"combobox",fieldLabel:"客户智能检索(ctrl+alt+c)",labelWidth:100,name:"shortName",displayField:"shortName",valueField:"id",queryParam:"shortName",forceSelection:!0,hideTrigger:!0,queryDelay:500,enableKeyEvents:!0,minChars:1,mode:"remote",anchor:"100%",listeners:{select:this.onCustomerSelect,
scope:this}}]});this.callParent();this.on("afterrender",this.initKeyMap,this)},onCustomerSelect:function(a,b){a.setValue("");var c=[];Ext.Array.each(b,function(a){c.push(Ext.create("WJM.model.TCustomer",a.getData()))});this.fireEvent("onProductLoad",{records:c})},setFocusCustomerQuickSearch:function(){console.log("customer");this.down("combobox").focus()},beforeDestroy:function(){Ext.destroy(this.keyMap);this.callParent()},initKeyMap:function(){this.keyMap=new Ext.util.KeyMap({target:"bodycss",key:"c",
fn:this.setFocusCustomerQuickSearch,scope:this,alt:!0,ctrl:!0,shift:!1,eventName:"keydown"});this.keyMap.enable()},beforehide:function(){this.keyMap.disable();this.callParent()}});
Ext.define("WJM.employee.ChangePasswordForm",{extend:"Ext.form.Panel",bodyPadding:10,closeAction:"destroy",initComponent:function(){Ext.applyIf(this,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:200},items:[{name:"password1",fieldLabel:"old password/旧密码",xtype:"textfield",allowBlank:!1,inputType:"password"},{name:"newpassword1",fieldLabel:"new password/新密码",xtype:"textfield",allowBlank:!1,inputType:"password"},{name:"newpassword2",fieldLabel:"confirm password/确认密码",xtype:"textfield",allowBlank:!1,
inputType:"password"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick}]}]});this.callParent(arguments)},onSaveClick:function(){var a=this;this.getForm().isValid()&&this.submit({url:"employee.do?action=change_password",success:function(){Ext.Msg.alert("提示","保存成功");a.fireEvent("saveSuccess",a)},failure:function(a,c){Ext.Msg.alert("提示",c.result.msg||"保存失败，请稍候重试")}})}});
Ext.define("WJM.employee.ChangePasswordModel",{extend:"Ext.ux.desktop.Module",id:"changepassword",init:function(){this.id=this.config.moduleId||"changepassword";this.title=this.config.menuText||"change password/修改密码"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);if(!b)var c=Ext.create("WJM.employee.ChangePasswordForm",{listeners:{saveSuccess:function(){b.destroy();location.href=location.context+"/login.do?action=logout"}}}),b=a.createWindow({id:this.id,title:this.title,
width:500,height:200,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[c]});return b}});
Ext.define("WJM.employee.EmployeeGrid",{extend:"Ext.grid.Panel",requires:["Ext.grid.Panel","WJM.model.TEmployee","Ext.grid.plugin.RowEditing"],editAble:!1,initComponent:function(){this.editing=Ext.create("Ext.grid.plugin.RowEditing",{clicksToEdit:2});this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"add",text:"添加",scope:this,handler:this.onAddClick},{iconCls:"remove",text:"删除",scope:this,handler:this.onDeleteClick},{iconCls:"search",text:"打印优惠确认码",scope:this,handler:this.onPrintApproverClick},
{xtype:"label",text:"双击列表项开始编辑"}]});var a=[{xtype:"rownumberer"},{text:"code/工号",dataIndex:"code",sortable:!0,width:100,editor:{xtype:"textfield",name:"code",allowBlank:!1,inputType:"text"}},{text:"name/名字",dataIndex:"name",sortable:!0,width:100,editor:{xtype:"textfield",allowBlank:!1,inputType:"text"}},{text:"department/部门",dataIndex:"department",sortable:!0,editor:{xtype:"textfield"}},{text:"position/职位",dataIndex:"headShip",sortable:!0,editor:{xtype:"textfield"}},{text:"tel/电话",dataIndex:"tel",
editor:{xtype:"textfield"}},{text:"cell phone/手机",dataIndex:"mobile",editor:{xtype:"textfield"}},{text:"address/地址",dataIndex:"address",editor:{xtype:"textfield"}}];Ext.apply(this,{store:"EmployeeStore",disableSelection:!1,loadMask:!0,plugins:[],viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop"})]},dockedItems:[],columns:a,bbar:Ext.create("Ext.PagingToolbar",{store:"EmployeeStore",displayInfo:!0,displayMsg:"显示 用户 {0} - {1} 总共 {2}",emptyMsg:"没有用户数据"})});this.editAble&&
(a.push({text:"password/密码",dataIndex:"password1",field:{xtype:"textfield",allowBlank:!1}}),a.push({text:"approver code/优惠确认码",width:150,xtype:"templatecolumn",tpl:'<tpl if="password1.length &gt; 0"><img src="barcode?msg={password1}&type=code128&fmt=png&res=150"></img></tpl>'}),a.push({text:"权限",dataIndex:"popedom",field:{xtype:"combobox",allowBlank:!1,displayField:"power_name",valueField:"id",store:"PowerStore"},renderer:function(a){if(a=Ext.data.StoreManager.lookup("PowerStore").getById(Number(a)))return a.get("power_name")}}),
Ext.apply(this,{dockedItems:[this.editTopBar],plugins:[this.editing]}));this.callParent()},onDeleteClick:function(){var a=this.getView().getSelectionModel().getSelection()[0];a?Ext.Msg.confirm("提示","确定要删除此用户么？",function(b){"yes"==b&&this.store.remove(a,WJM.Config.defaultOperation)},this):Ext.Msg.alert("提示","请选择用户")},onAddClick:function(){var a=Ext.create("WJM.model.TEmployee"),b=this.editing;b.cancelEdit();this.store.insert(0,a,WJM.Config.defaultOperation);b.startEdit(0,0)},onPrintApproverClick:function(){var a=
this.getView().getSelectionModel().getSelection()[0];a?window.open(location.context+"/back/print_barcode.jsp?code="+a.get("password1"),"_blank"):Ext.Msg.alert("提示","请选择用户")}});
Ext.define("WJM.employee.EmployeeManageModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TEmployee"],id:"employee",init:function(){this.id=this.config.moduleId||"employee";this.title=this.config.menuText||"employee/员工"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);if(!b){var c=Ext.create("WJM.employee.EmployeeGrid",{editAble:!0}),b=a.createWindow({id:this.id,title:this.title,width:740,height:480,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",
items:[c]});c.getStore().loadPage(1)}return b}});
Ext.define("WJM.employee.LoginWindow",{extend:"Ext.window.Window",height:350,width:350,resizable:!1,layout:{type:"fit"},closable:!1,title:"欢迎您，请登录",constrain:!1,submitConfig:{success:function(a,b){Ext.Msg.alert("Success",b.result.msg)},failure:function(a,b){Ext.Msg.alert("Failed",b.result.msg)}},initComponent:function(){Ext.applyIf(this,{items:[{url:"login.do?action=login",xtype:"form",bodyPadding:20,items:[{xtype:"container",height:180,layout:{align:"center",type:"vbox"},items:[{xtype:"image",height:140,
src:"images/duser140.png",width:140}]},{xtype:"textfield",fieldLabel:"用户名",anchor:"100%",name:"code",labelWidth:50,allowBlank:!1},{xtype:"textfield",fieldLabel:"密码",anchor:"100%",inputType:"password",name:"password1",labelWidth:50,allowBlank:!1},{xtype:"container",height:60,padding:"10 0 0 0",layout:{align:"center",type:"vbox"},items:[{xtype:"button",scale:"medium",width:90,text:'<span style="font-size:16px;">登&nbsp;&nbsp;&nbsp;&nbsp;录</span>',type:"submit",listeners:{click:{fn:this.onButtonClick,
scope:this}}}]}]}]});this.callParent(arguments);this.on("afterrender",this.initKeyNav,this)},onButtonClick:function(){this.loginIn()},loginIn:function(){var a=this.down("form").getForm();a.isValid()&&a.submit(this.submitConfig)},initKeyNav:function(){Ext.create("Ext.util.KeyNav",this.getEl().dom,{scope:this,enter:function(){this.loginIn()}})}});
Ext.define("WJM.power.PowerForm",{extend:"Ext.form.Panel",requires:["Ext.form.*","WJM.model.TPower","WJM.model.TPowerOperation"],closeAction:"destroy",powerRecord:null,initComponent:function(){var a=[],b=[{fieldLabel:"role name/角色",name:"power_name",xtype:"textfield",allowBlank:!1,value:this.powerRecord?this.powerRecord.get("power_name"):"",anchor:"100%"},{xtype:"hiddenfield",value:this.powerRecord?this.powerRecord.get("id"):"0",name:"id",anchor:"100%"},{xtype:"fieldset",title:"power/权限",items:a}];
Ext.Object.each(WJM.Config.powerOperationModule,function(b,d){a.push(Ext.create("Ext.form.field.Checkbox",{boxLabel:d.menuText,name:"power_items",inputValue:b,anchor:"100%"}))});Ext.apply(this,{title:this.powerRecord?this.powerRecord.get("power_name"):"新建角色",bodyPadding:10,autoScroll:!0,url:location.context+"/power.do?action=save",collapsed:!1,items:b,dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick},{iconCls:"remove",text:"删除",scope:this,
handler:this.onDeleteClick}]}]});this.on("expand",this.initOprations,this);this.callParent(arguments)},initOprations:function(){if(this.powerRecord){var a=this.powerRecord.getId(),b=this;Ext.ModelManager.getModel("WJM.model.TPower").load(a,{success:function(a){a=a.getAssociatedData().operations;Ext.Array.each(a,function(a){b.getForm().getFields().each(function(b){b.inputValue==a.operationCode&&b.setValue(!0)})})}})}},onDeleteClick:function(){Ext.Msg.confirm("提示","确定要删除此角色么？",function(a){if("yes"==
a){var b=this;this.getForm().submit({url:"power.do?action=del",success:function(){Ext.data.StoreManager.lookup("PowerStore").load();b.fireEvent("deleteSuccess",b);Ext.Msg.alert("提示","删除成功")},failure:function(){Ext.Msg.alert("错误","删除失败，请稍后重试")}})}},this)},onSaveClick:function(){var a=this;this.getForm().submit({url:"power.do?action=save",success:function(b){Ext.data.StoreManager.lookup("PowerStore").load();b=b.findField("power_name");a.setTitle(b.getValue());Ext.Msg.alert("提示","保存成功")},failure:function(){Ext.Msg.alert("错误",
"保存失败，请稍后重试")}})}});
Ext.define("WJM.power.PowerManageModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TPower","WJM.model.TPowerOperation"],id:"power",init:function(){this.id=this.config.moduleId||"power";this.title=this.config.menuText||"permission/权限"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);if(!b){var c=[],d=this;Ext.data.StoreManager.lookup("PowerStore").each(function(a){c.push(Ext.create("WJM.power.PowerForm",{powerRecord:a,listeners:{deleteSuccess:d.onDeleteSuccess,scope:d}}));
return!0});b=a.createWindow({id:this.id,title:this.title,width:300,height:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:{type:"accordion"},items:c,dockedItems:[{xtype:"toolbar",dock:"top",items:[{iconCls:"add",text:"添加角色",scope:d,handler:d.onAddClick}]}]});c[0].initOprations()}return b},onAddClick:function(){var a=this.app.getDesktop().getWindow(this.id);if(a){var b=Ext.create("WJM.power.PowerForm",{powerRecord:null,parentId:this.id});a.add(b);b.expand(!0)}},onDeleteSuccess:function(a){var b=
a.up("window");b.remove(a,!0);(a=b.getComponent(0))&&a.expand(!0)}});
Ext.define("WJM.product.ProductAlert",{mixins:{observable:"Ext.util.Observable"},requires:["Ext.window.MessageBox","WJM.model.TProduct"],singleton:!0,constructor:function(a){this.mixins.observable.constructor.call(this,a);this.callParent(arguments);this.store=Ext.data.StoreManager.lookup("ProductAlertStore");this.store.on("load",this.onProductListLoad,this)},checkProduct:function(){this.store.load()},onProductListLoad:function(){0>=this.store.getCount()||(win=myDesktopApp.getDesktop().createWindow({title:"产品库存报警(按住ctrl多选，拖动产品到订货列表)",
width:500,height:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.product.widget.ProductGrid",{productStore:"ProductAlertStore"})]}),win.show())}});
Ext.define("WJM.product.ProductCategoryForm",{extend:"Ext.form.Panel",record:null,bodyPadding:10,closeAction:"destroy",initComponent:function(){Ext.applyIf(this,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:100},items:[{name:"id",xtype:"hiddenfield"},{name:"parent_id",xtype:"hiddenfield"},{name:"code",fieldLabel:"code/类别编码",allowBlank:!1},{name:"product_type_name",fieldLabel:"name/类别名",allowBlank:!1},{fieldLabel:"Upper Category/上一级类别",readOnly:!0,name:"parent_product_type_name",xtype:"hiddenfield"},
{fieldLabel:"level/级别",name:"level",readOnly:!0,xtype:"hiddenfield"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick}]}]});this.callParent(arguments);this.record&&this.loadRecord(this.record)},onSaveClick:function(){var a=this;this.getForm().isValid()&&this.submit({url:"product_type.do?action=save",success:function(){Ext.Msg.alert("提示","保存成功");a.fireEvent("saveSuccess",a)},failure:function(){Ext.Msg.alert("提示","保存失败，请稍候重试")}})}});
Ext.define("WJM.product.ProductCategoryManageModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TProductCategory"],id:"productcategory",init:function(){this.id=this.config.moduleId||"productcategory";this.title=this.config.menuText||"product category/产品种类"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.product.ProductCategoryTree",{editAble:!0}),b=a.createWindow({id:this.id,title:this.title,width:400,height:500,iconCls:"icon-grid",animCollapse:!1,
constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.product.ProductCategoryTree",{extend:"Ext.tree.Panel",requires:["Ext.tree.Panel","WJM.model.TProductCategory"],editAble:!1,initComponent:function(){this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[{iconCls:"add",text:"添加根类别",scope:this,handler:this.onAddRootClick},{iconCls:"add",text:"添加子类别",scope:this,handler:this.onAddLeafClick},{iconCls:"edit",text:"编辑类别",scope:this,handler:this.onEditClick},{iconCls:"remove",text:"删除",scope:this,handler:this.onDeleteClick}]});
var a=[{xtype:"treecolumn",text:"name/类别",flex:2,sortable:!0,dataIndex:"product_type_name"},{text:"code/类别编号",sortable:!0,dataIndex:"code",align:"center"}];Ext.apply(this,{store:"ProductCategoryStore",loadMask:!0,rootVisible:!0,multiSelect:!1,singleExpand:!1,viewConfig:{plugins:[{ptype:"treeviewdragdrop",ddGroup:"TProductCategory",enableDrop:!1}]},columns:a});this.editAble&&(Ext.apply(this,{dockedItems:[],viewConfig:{plugins:[{ptype:"treeviewdragdrop",ddGroup:"TProductCategory",enableDrop:!0}]}}),
a.push({text:"id/类别id",flex:1,dataIndex:"id",sortable:!0}),this.on("afterrender",this.initContextmenu,this));this.callParent()},initContextmenu:function(){this.contextMenu=new Ext.menu.Menu({items:[{text:"添加类别",handler:this.onAddClick,scope:this,minWindows:1},{text:"修改类别",handler:this.onEditClick,scope:this,minWindows:1},{text:"删除类别",handler:this.onDeleteClick,scope:this,minWindows:1}]});this.getEl().on("contextmenu",function(a){var b=this.contextMenu;a.stopEvent();b.showAt(a.getXY());b.doConstrain()},
this)},onDeleteClick:function(){var a=this.getView().getSelectionModel().getSelection()[0];a?Ext.Msg.confirm("提示","确定要删除此类别么？",function(b){"yes"==b&&a.remove(!0)},this):Ext.Msg.alert("提示","请选择类别")},onAddRootClick:function(){win=myDesktopApp.getDesktop().createWindow({title:"新建类别",height:150,width:300,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.product.ProductCategoryForm",{record:Ext.create("WJM.model.TProductCategory",{level:1,parent_id:0,parent_product_type_name:"根节点"}),
listeners:{saveSuccess:this.onSaveSuccess,scope:this}})]});win.show()},onAddLeafClick:function(){var a=this.getSelectionModel().getSelection()[0];a?(win=myDesktopApp.getDesktop().createWindow({title:"新建类别",height:150,width:300,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.product.ProductCategoryForm",{record:Ext.create("WJM.model.TProductCategory",{level:a.get("level")+1,parent_id:a.get("id"),parent_product_type_name:a.get("product_type_name")}),listeners:{saveSuccess:this.onSaveSuccess,
scope:this}})]}),win.show()):Ext.Msg.alert("提示","请选择类别")},onAddClick:function(){if(this.getSelectionModel().getSelection()[0])this.onAddLeafClick();else this.onAddRootClick()},onSaveSuccess:function(a){Ext.data.StoreManager.lookup("ProductCategoryStore").load();Ext.data.StoreManager.lookup("ProductCategoryAllStore").load();a.up("window").destroy()},onEditClick:function(){var a=this.getSelectionModel().getSelection()[0];if(a){var b=Ext.data.StoreManager.lookup("ProductCategoryStore").getNodeById(a.get("parent_id"));
b?a.set("parent_product_type_name",b.get("product_type_name")):a.set("parent_product_type_name","根节点");win=myDesktopApp.getDesktop().createWindow({title:a.get("product_type_name"),height:150,width:300,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.product.ProductCategoryForm",{record:a,listeners:{saveSuccess:this.onSaveSuccess,scope:this}})]});win.show()}else Ext.Msg.alert("提示","请选择类别")}});
Ext.define("WJM.product.ProductForm",{extend:"Ext.form.Panel",requires:["WJM.model.TProductVendor","Ext.ux.CheckColumn"],record:null,height:600,width:400,bodyPadding:10,closeAction:"destroy",initComponent:function(){var a=this;this.gridStoreId=Ext.Number.randomInt(1E6,9999999).toString();Ext.create("Ext.data.Store",{storeId:this.gridStoreId,autoLoad:!1,model:"WJM.model.TVendor"});Ext.applyIf(a,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},{anchor:"100%",
height:100,disableSelection:!1,loadMask:!0,xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"vendor name/供货商",dataIndex:"vendor_name",sortable:!0,width:150},{text:"cost/供货价格",dataIndex:"price",sortable:!0,xtype:"numbercolumn",format:"$0.00",width:150,editor:{xtype:"adnumberfield",allowBlank:!1,minValue:0}},{xtype:"checkcolumn",text:"定价",dataIndex:"useDefaultBoolean",width:90,stopSelection:!0,editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},listeners:{checkchange:a.onCheckchange,scope:a}}],
store:this.gridStoreId,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1,listeners:{edit:a.calculatePrice,scope:a}})],viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop",ddGroup:"TVendor",enableDrop:!0,enableDrag:!1})],listeners:{drop:function(){},beforedrop:function(b,d){d.copy=!0;var e=a.down("gridpanel").getStore();d.records=Ext.Array.filter(d.records,function(a){return e.findRecord("vendor_id",a.getId(),0,!1,!1,!0)?!1:!0});d.records=this.recoverTVendor(d.records)},
scope:a}}},{title:"从任意的产品类别列表中拖动列表项到此区域",xtype:"fieldset",layout:"anchor",allowBlank:!1,items:[{name:"product_type",xtype:"hiddenfield"},{fieldLabel:"category code/类别code",name:"product_type_code",readOnly:!1,allowBlank:!1,xtype:"textfield",anchor:"100%",labelWidth:150},{fieldLabel:"category name/类别名称",name:"product_type_name",allowBlank:!1,readOnly:!0,xtype:"textfield",anchor:"100%",labelWidth:150}]},{name:"code",fieldLabel:"barcode #/条码",allowBlank:!0},{name:"product_id",fieldLabel:"items id/助记符",
allowBlank:!0},{name:"product_name",fieldLabel:"description 1",allowBlank:!0},{name:"product_name_cn",fieldLabel:"description 2",allowBlank:!0},{name:"size",fieldLabel:"retail percentage/零售%",allowBlank:!0,xtype:"numberfield",enableKeyEvents:!0,listeners:{keyup:this.calculatePrice,scope:a}},{name:"price_simgle",fieldLabel:"retail price/零售价格",minValue:0,xtype:"adnumberfield",enableKeyEvents:!0,listeners:{keyup:this.calculatePercentage,scope:a}},{name:"weight",fieldLabel:"WHLS percentage/批发价%",xtype:"numberfield",
allowBlank:!0,enableKeyEvents:!0,listeners:{keyup:this.calculatePrice,scope:a}},{name:"price_wholesale",fieldLabel:"WHLS price/批发价",xtype:"adnumberfield",allowBlank:!0,enableKeyEvents:!0,listeners:{keyup:this.calculatePercentage,scope:a}},{name:"num",fieldLabel:"quantity/数量",minValue:0,xtype:"numberfield",allowDecimals:!1},{name:"downLimit",fieldLabel:"min Stock/最小库存",allowBlank:!0,xtype:"numberfield",allowDecimals:!1,minValue:0},{name:"myMemo",fieldLabel:"remark/备注",xtype:"textareafield",allowBlank:!0}],
dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick},{xtype:"button",iconCls:"remove",text:"删除供货商",scope:this,handler:this.onDeleteVendor},{xtype:"button",iconCls:"search",text:"搜索供货商",scope:this,handler:this.onVendorSearchClick},{xtype:"button",iconCls:"search",text:"搜索产品类别",scope:this,handler:this.onCategorySearchClick}]}]});a.on("afterrender",this.initDragDorp,this);a.callParent(arguments);if(this.record){a.loadRecord(this.record);
var b=Ext.data.StoreManager.lookup("ProductVendorStore");b.getProxy().setExtraParam("product_id",this.record.getId());b.getProxy().setExtraParam("product_name",null);b.getProxy().setExtraParam("vendor_id",null);b.getProxy().setExtraParam("vendor_name",null);b.load({scope:this,callback:this.onProductVendorLoad});b=Ext.data.StoreManager.lookup("ProductCategoryAllStore");(b=b.getById(Number(this.record.get("product_type"))))&&this.setProductType(b)}},setProductType:function(a){this.getForm().findField("product_type").setValue(a.getId());
this.getForm().findField("product_type_code").setValue(a.get("code"));this.getForm().findField("product_type_name").setValue(a.get("product_type_name"))},onProductVendorLoad:function(a,b,c){c&&this.down("grid").getStore().loadRecords(a)},recoverTVendor:function(a){var b=[];Ext.Array.each(a,function(a){var d=Ext.create("WJM.model.TProductVendor");d.set("vendor_id",a.getId());d.set("vendor_name",a.get("shortName"));d.set("price",0);d.set("useDefault",0);d.set("useDefaultBoolean",!1);d.set("id",(new Date).getTime());
b.push(d)});return b},initDragDorp:function(){var a=this;this.dragDorp=Ext.create("Ext.dd.DropTarget",this.down('fieldset[title="从任意的产品类别列表中拖动列表项到此区域"]').getEl().dom,{ddGroup:"TProductCategory",notifyEnter:function(){a.stopAnimation();a.getEl().highlight()},notifyDrop:function(b){a.setProductType(b.dragData.records[0]);return!0}})},onSaveClick:function(){var a=this.getForm(),b=this,c=[],d=!0;this.down("gridpanel").getStore().data.each(function(a){c.push(a.getData());if(!a.get("price")||0>=a.get("price"))d=
!1});if(0>=c.length)Ext.Msg.alert("提示","请添加供应商！");else if(d){var e=Ext.data.StoreManager.lookup("ProductCategoryAllStore"),f=this.getForm().findField("product_type_code").getValue();(e=e.findRecord("code",f,0,!1,!1,!0))?(b.setProductType(e),a.isValid()&&(0==c.length?Ext.Msg.alert("提示","请选择供应商"):this.submit({url:"product.do?action=save2",params:{productProviderJson:Ext.JSON.encode(c)},success:function(){Ext.Msg.alert("提示","保存成功");b.fireEvent("saveSuccess",b)},failure:function(a,b){Ext.Msg.alert("提示",
b.result.msg||"保存失败，请稍候重试")}}))):Ext.Msg.alert("提示","根据code未找到对应的类别！")}else Ext.Msg.alert("提示","列表中供货商供货价格不正确！")},onVendorSearchClick:function(){var a=myDesktopApp.getDesktop(),b=a.getWindow("VendorSearchGrid");b||(b=Ext.create("WJM.vendor.VendorGrid",{editAble:!1}),b=a.createWindow({id:"VendorSearchGrid",title:"供货商检索",width:600,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));b.show()},onCategorySearchClick:function(){var a=myDesktopApp.getDesktop(),b=a.getWindow("ProductCategorySearchGrid");
b||(b=Ext.create("WJM.product.ProductCategoryTree",{width:200,editAble:!1,collapsible:!0,title:"类别检索"}),b=a.createWindow({id:"ProductCategorySearchGrid",title:"类别检索",width:200,height:400,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));b.show()},onDeleteVendor:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];a?(this.down("grid").getStore().remove(a),Ext.Msg.alert("提示","删除成功，请保存产品！")):Ext.Msg.alert("提示","请选择供货商。")},calculatePrice:function(){var a=
this.down("gridpanel").getStore().findRecord("useDefault","1");if(a){var a=a.get("price")+0,b=this.getForm().findField("size").getValue()+0,c=this.getForm().findField("weight").getValue()+0;this.getForm().findField("price_simgle").setValue(a*(1+b/100));this.getForm().findField("price_wholesale").setValue(a*(1+c/100))}},calculatePercentage:function(){var a=this.down("gridpanel").getStore().findRecord("useDefault","1");if(a){var a=a.get("price")+0,b=this.getForm().findField("price_simgle").getValue()+
0,c=this.getForm().findField("price_wholesale").getValue()+0;0!=a&&(this.getForm().findField("size").setValue(100*((b-a)/a)),this.getForm().findField("weight").setValue(100*((c-a)/a)))}},beforeDestroy:function(){this.clearForm();Ext.data.StoreManager.unregister(this.gridStoreId);Ext.destroy(this.dragDorp);this.callParent()},clearForm:function(){this.down("gridpanel").getStore().removeAll();this.record=null;this.getForm().getFields().each(function(a){a.setValue("")})},onCheckchange:function(a,b,c){if(c)for(var a=
this.down("gridpanel").getStore(),c=a.count(),d=0;d<c;d++)d!=b?(a.getAt(d).set("useDefault",0),a.getAt(d).set("useDefaultBoolean",!1)):(a.getAt(d).set("useDefault",1),a.getAt(d).set("useDefaultBoolean",!0));this.calculatePrice()}});
Ext.define("WJM.product.ProductGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel","WJM.product.ProductCategoryTree"],editAble:!1,hasCost:!0,layout:{type:"border",padding:2},defaults:{split:!0},initComponent:function(){var a=[];this.editTopBar=this.editAble?Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"add",text:"添加",scope:this,handler:this.onAddClick},{iconCls:"edit",text:"编辑",scope:this,handler:this.onEditClick},{iconCls:"remove",
text:"删除",scope:this,handler:this.onDeleteClick}]}):Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick}]});a=this.hasCost?[{xtype:"rownumberer"},{text:"items id/助记符",dataIndex:"product_id",sortable:!0,width:100},{text:"barcode #/条码",dataIndex:"code",sortable:!0,width:100},{text:"description 1",dataIndex:"product_name",sortable:!0,width:200},{text:"description 2",dataIndex:"product_name_cn",sortable:!0,width:200},{text:"category id/分类",dataIndex:"product_type",
sortable:!0,width:100,renderer:function(a){if(a=Ext.data.StoreManager.lookup("ProductCategoryAllStore").getById(Number(a)))return a.get("product_type_name")}},{text:"cost/进货价",dataIndex:"price_income",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"sale price/销售价格",dataIndex:"price_simgle",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"WHLS price",dataIndex:"price_wholesale",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"quantity/数量",dataIndex:"num",sortable:!0},{text:"vendor/供货商",
dataIndex:"vendortName",sortable:!0}]:[{xtype:"rownumberer"},{text:"items id/助记符",dataIndex:"product_id",sortable:!0,width:100},{text:"barcode #/条码",dataIndex:"code",sortable:!0,width:100},{text:"description 1",dataIndex:"product_name",sortable:!0,width:200},{text:"description 2",dataIndex:"product_name_cn",sortable:!0,width:200},{text:"category id/分类",dataIndex:"product_type",sortable:!0,width:100,renderer:function(a){if(a=Ext.data.StoreManager.lookup("ProductCategoryAllStore").getById(Number(a)))return a.get("product_type_name")}},
{text:"sale price/销售价格",dataIndex:"price_simgle",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"WHLS price",dataIndex:"price_wholesale",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"quantity/数量",dataIndex:"num",sortable:!0},{text:"vendor/供货商",dataIndex:"vendortName",sortable:!0}];Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"名称检索",layout:{columns:2,type:"table"},bodyPadding:10,
items:[{xtype:"textfield",fieldLabel:"items id/助记符",labelWidth:150,name:"product_id",listeners:{change:this.onAutoSearch,scope:this}},{xtype:"textfield",fieldLabel:"barcode #/条码",labelWidth:150,name:"code",listeners:{change:this.onAutoSearch,scope:this}},{xtype:"textfield",fieldLabel:"description",labelWidth:150,name:"product_name",listeners:{change:this.onAutoSearch,scope:this}}]},Ext.create("WJM.product.ProductCategoryTree",{region:"west",width:200,editAble:!1,collapsible:!0,title:"类别检索",editAble:this.editAble,
listeners:{selectionchange:function(a){if(a=a.getSelection()[0]){this.clearExtraParam();var c=Ext.data.StoreManager.lookup("ProductStore");c.getProxy().setExtraParam("product_type",a.getId());c.loadPage(1)}},scope:this}}),{store:"ProductStore",disableSelection:!1,multiSelect:!0,loadMask:!0,region:"center",xtype:"gridpanel",columns:a,viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop",ddGroup:"TProduct",enableDrop:!1})]},bbar:Ext.create("Ext.PagingToolbar",{store:"ProductStore",
displayInfo:!0,displayMsg:"显示 产品 {0} - {1} 总共 {2}",emptyMsg:"没有产品数据"})}]});Ext.data.StoreManager.lookup("ProductStore").loadPage(1);this.callParent()},onAutoSearch:function(a,b){if(b&&3<=b.length)this.onSearchClick()},onDeleteClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];a?Ext.Msg.confirm("提示","确定要删除此产品么？",function(b){"yes"==b&&Ext.data.StoreManager.lookup("ProductStore").remove(a)},this):Ext.Msg.alert("提示","请选择产品")},onAddClick:function(){var a=myDesktopApp.getDesktop(),
b=a.getWindow("ProductForm");b&&b.destroy();b=a.createWindow({title:"新建产品",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.product.ProductForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this}})]});b.show()},onEditClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];if(a){var b=myDesktopApp.getDesktop(),c=Ext.create("WJM.product.ProductForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a}),d=b.getWindow("ProductForm");
d&&d.destroy();d=b.createWindow({title:"编辑产品",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[c]});d.show();c.getForm().loadRecord(a)}else Ext.Msg.alert("提示","请选择产品")},onSaveSuccess:function(a){a.ownerCt.destroy();Ext.data.StoreManager.lookup("ProductStore").loadPage(1);this.show()},onSearchClick:function(){this.clearExtraParam();var a=this.down("form").getForm().getFieldValues(),b=Ext.data.StoreManager.lookup("ProductStore");Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,
d)});b.loadPage(1)},clearExtraParam:function(){var a=this.down("form").getForm().getFieldValues(),b=Ext.data.StoreManager.lookup("ProductStore");Ext.Object.each(a,function(a){b.getProxy().setExtraParam(a,null)});b.getProxy().setExtraParam("product_type",null)}});
Ext.define("WJM.product.ProductManageModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TProduct"],id:"product",init:function(){this.id=this.config.moduleId||"product";this.title=this.config.menuText||"product/产品"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.product.ProductGrid",{editAble:!0,hasCost:!0}),b=a.createWindow({id:this.id,title:this.title,width:800,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",
items:b}));return b}});
Ext.define("WJM.product.ProductQuickSearchForm",{extend:"Ext.form.Panel",requires:["WJM.model.TProduct"],keyMapTarget:null,keyMap:null,initComponent:function(){Ext.apply(this,{bodyPadding:10,items:[{store:"ProductQuickStore",xtype:"combobox",fieldLabel:"产品智能检索(ctrl+alt+p)",labelWidth:100,name:"product_quick",displayField:"product_name_full",valueField:"id",queryParam:"product_quick",forceSelection:!0,hideTrigger:!0,queryDelay:0,enableKeyEvents:!0,minChars:1,mode:"remote",anchor:"100%",listeners:{select:this.onProductSelect,
scope:this}}]});this.callParent();this.on("afterrender",this.initKeyMap,this)},onProductSelect:function(a,b){a.setValue("");var c=[];Ext.Array.each(b,function(a){c.push(Ext.create("WJM.model.TProduct",a.getData()))});this.fireEvent("onProductLoad",{records:c})},setFocusProductQuickSearch:function(){console.log("customer");this.down("combobox").focus()},beforeDestroy:function(){Ext.destroy(this.keyMap);this.callParent()},initKeyMap:function(){this.keyMap=new Ext.util.KeyMap({target:"bodycss",key:"p",
fn:this.setFocusProductQuickSearch,scope:this,eventName:"keydown",alt:!0,ctrl:!0,shift:!1});this.keyMap.enable()},beforehide:function(){this.keyMap.disable();this.callParent()}});
Ext.define("WJM.product.ProductSearchModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TProduct"],id:"productsearch",init:function(){this.id=this.config.moduleId||"productsearch";this.title=this.config.menuText||"search/产品搜索"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.product.ProductGrid",{editAble:!1,hasCost:WJM.Config.hasProductManageRole()}),b=a.createWindow({id:this.id,title:this.title,width:800,height:600,iconCls:"icon-grid",animCollapse:!1,
constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.product.widget.ProductGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],editAble:!1,hasCost:!0,layout:{type:"border",padding:2},defaults:{split:!0},productStore:"ProductStore",initComponent:function(){var a=[];this.editTopBar=this.editAble?Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"add",text:"添加",scope:this,handler:this.onAddClick},{iconCls:"edit",text:"编辑",scope:this,handler:this.onEditClick},{iconCls:"remove",text:"删除",scope:this,handler:this.onDeleteClick}]}):
null;a=this.hasCost?[{xtype:"rownumberer"},{text:"items id/助记符",dataIndex:"product_id",sortable:!0,width:100},{text:"barcode #/条码",dataIndex:"code",sortable:!0,width:100},{text:"description 1",dataIndex:"product_name",sortable:!0,width:200},{text:"description 2",dataIndex:"product_name_cn",sortable:!0,width:200},{text:"category id/分类",dataIndex:"product_type",sortable:!0,width:100,renderer:function(a){if(a=Ext.data.StoreManager.lookup("ProductCategoryAllStore").getById(Number(a)))return a.get("product_type_name")}},
{text:"cost/进货价",dataIndex:"price_income",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"sale price/销售价格",dataIndex:"price_simgle",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"WHLS price",dataIndex:"price_wholesale",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"quantity/数量",dataIndex:"num",sortable:!0},{text:"min Stock/最小库存",dataIndex:"downLimit",sortable:!0},{text:"vendor/供货商",dataIndex:"vendortName",sortable:!0}]:[{xtype:"rownumberer"},{text:"items id/助记符",dataIndex:"product_id",
sortable:!0,width:100},{text:"barcode #/条码",dataIndex:"code",sortable:!0,width:100},{text:"description 1",dataIndex:"product_name",sortable:!0,width:200},{text:"description 2",dataIndex:"product_name_cn",sortable:!0,width:200},{text:"category id/分类",dataIndex:"product_type",sortable:!0,width:100,renderer:function(a){if(a=Ext.data.StoreManager.lookup("ProductCategoryAllStore").getById(Number(a)))return a.get("product_type_name")}},{text:"sale price/销售价格",dataIndex:"price_simgle",sortable:!0,xtype:"numbercolumn"},
{text:"WHLS price",dataIndex:"price_wholesale",sortable:!0,xtype:"numbercolumn"},{text:"quantity/数量",dataIndex:"num",sortable:!0},{text:"min Stock/最小库存",dataIndex:"downLimit",sortable:!0},{text:"vendor/供货商",dataIndex:"vendortName",sortable:!0}];Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{store:this.productStore,disableSelection:!1,multiSelect:!0,loadMask:!0,region:"center",xtype:"gridpanel",columns:a,viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop",
ddGroup:"TProduct",enableDrop:!1})]},bbar:Ext.create("Ext.PagingToolbar",{store:this.productStore,displayInfo:!0,displayMsg:"显示 产品 {0} - {1} 总共 {2}",emptyMsg:"没有产品数据"})}]});this.callParent()},onDeleteClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];a?Ext.Msg.confirm("提示","确定要删除此产品么？",function(b){"yes"==b&&Ext.data.StoreManager.lookup("ProductStore").remove(a)},this):Ext.Msg.alert("提示","请选择产品")},onAddClick:function(){win=myDesktopApp.getDesktop().createWindow({title:"新建产品",
iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.product.ProductForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this}})]});win.show()},onEditClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];if(a){var b=myDesktopApp.getDesktop(),c=Ext.create("WJM.product.ProductForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"编辑产品",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,
layout:"fit",items:[c]});win.show();c.getForm().loadRecord(a)}else Ext.Msg.alert("提示","请选择产品")},onSaveSuccess:function(a){a.ownerCt.destroy();Ext.data.StoreManager.lookup("ProductStore").loadPage(1);this.show()}});
Ext.define("WJM.purchase.MyPurchaseModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TPurchase","WJM.model.TPurchaseProduct"],id:"mypurchase",init:function(){this.id=this.config.moduleId||"mypurchase";this.title=this.config.menuText||"my P.O./我的订货"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.purchase.PurchaseGrid",{editAble:!0,receiveAble:!1,cashAble:!1,deleteAble:!0,purchaseStore:"PurchaseMyStore",purchaseProductStore:"PurchaseProductMyStore",
onlyMy:!0}),b=a.createWindow({id:this.id,title:this.title,width:980,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.purchase.PurchaseForm",{extend:"Ext.form.Panel",requires:["WJM.model.TPurchase","WJM.model.TProductVendor","WJM.model.TProduct"],bodyPadding:10,record:null,initComponent:function(){var a=this;this.gridStoreId=Ext.Number.randomInt(1E6,9999999).toString();Ext.create("Ext.data.Store",{storeId:this.gridStoreId,autoLoad:!1,model:"WJM.model.TProduct"});var b=[{xtype:"rownumberer"},{text:"barcode #/条码",dataIndex:"code",sortable:!0,width:100},{text:"description 1",dataIndex:"product_name",
sortable:!0,width:200},{text:"unit price/单价",dataIndex:"price_income",sortable:!0,xtype:"numbercolumn",format:"$0.00",editor:{xtype:"adnumberfield",allowBlank:!1,minValue:0}},{text:"vendor/供应商",dataIndex:"vendortName",sortable:!0,editor:{xtype:"combobox",name:"provider_id",displayField:"vendor_name",valueField:"vendor_name",store:"ProductVendorStore",allowBlank:!1,listeners:{select:a.onVendorSelect,scope:a}}},{text:"quantity/数量",dataIndex:"num",sortable:!0,xtype:"numbercolumn",format:"0,000",editor:{xtype:"numberfield",
allowBlank:!1,allowDecimals:!1,minValue:0}},{text:"sub total/小计",dataIndex:"total",sortable:!0,xtype:"numbercolumn",format:"$0.00"}];this.editor=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1,listeners:{edit:a.calculateTotal,scope:a,beforeedit:a.onGridBeforeEdit}});Ext.applyIf(a,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},Ext.create("WJM.product.ProductQuickSearchForm",{anchor:"100%",height:50,listeners:{onProductLoad:a.onProductLoad,
scope:a}}),{anchor:"100% -150",disableSelection:!1,loadMask:!0,xtype:"gridpanel",columns:b,plugins:[this.editor],store:this.gridStoreId,viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ddGroup:"TProduct",enableDrop:!0,enableDrag:!1})],listeners:{drop:function(a,b){for(var e=0;e<b.records.length;e++){var f=b.records[e];"WJM.model.TSaleProduct"==f.modelName&&(f.set("id",f.get("product_id")),f.set("price_income","-1"))}this.calculateTotal()},beforedrop:function(b,d){d.copy=!0;var e=a.down("gridpanel").getStore();
d.records=Ext.Array.filter(d.records,function(a){if(a.isModel){if("WJM.model.TSaleProduct"==a.modelName)return(a=e.getById(a.get("product_id")))?!1:!0;if("WJM.model.TProduct"==a.modelName)return(a=e.getById(a.getId()))?!1:!0}return!1});this.calculateTotal()},scope:a}}},{xtype:"container",padding:"10 0 0 0",layout:{columns:2,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"50%"}}},items:[{xtype:"textfield",name:"oper_name",labelWidth:110,width:"90%",fieldLabel:"Worker ID/操作员",
allowBlank:!1,readOnly:!0,value:window.user.userName},{xtype:"textfield",name:"oper_time",fieldLabel:"date/时间",width:"90%",labelWidth:110,allowBlank:!1,readOnly:!0,value:Ext.Date.format(new Date,"Y-m-d H:i:s")}]},{name:"all_purchase_price",fieldLabel:"Total/总计",allowBlank:!1,readOnly:!0,xtype:"adnumberfield",minValue:0}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick},{xtype:"button",iconCls:"search",text:"搜索产品",scope:this,
handler:this.onProductSearchClick},{xtype:"button",iconCls:"search",text:"从订单选择产品",scope:this,handler:this.onSearchSaleClick},{xtype:"button",iconCls:"search",text:"清空",scope:this,handler:this.clearForm},{xtype:"button",iconCls:"remove",text:"删除产品",scope:this,handler:this.onRemoveProductClick}]}]});a.callParent(arguments);this.record&&(a.loadRecord(this.record),b=Ext.data.StoreManager.lookup("PurchaseProductStore"),b.getProxy().setExtraParam("purchase_id",this.record.getId()),b.load({scope:this,callback:this.onPurchaseProductLoad}))},
onSaveClick:function(){var a=this.getForm(),b=this,c=[],d=!0;this.down("gridpanel").getStore().data.each(function(a){if(!a.get("provider_id")||0==a.get("provider_id"))d=!1;c.push(a.getData())});d?(this.calculateTotal(),a.isValid()&&(0==c.length?Ext.Msg.alert("提示","请选择产品"):this.submit({url:"purchase_order.do?action=stock_submit_old",params:{purchaseProducts:Ext.JSON.encode(c)},success:function(a,c){Ext.Msg.alert("提示","保存成功");b.clearForm();var d=c.result;d.purchase_id&&Ext.Array.each(d.purchase_id,
function(a){window.open(location.context+"/purchase_order.do?action=print_bill&id="+a,"_blank")});b.fireEvent("saveSuccess",b)},failure:function(a,b){Ext.Msg.alert("提示",b.result.msg||"保存失败，请稍候重试")}}))):Ext.Msg.alert("提示","请选择产品的供应商！")},onProductSearchClick:function(){var a=myDesktopApp.getDesktop(),b=a.getWindow("productsearch");b||(b=Ext.create("WJM.product.ProductGrid",{editAble:!1}),b=a.createWindow({id:"productsearch",title:"search/产品搜索",width:600,height:600,iconCls:"icon-grid",animCollapse:!1,
constrainHeader:!0,layout:"fit",items:[b]}));b.show()},onVendorSearchClick:function(){var a=myDesktopApp.getDesktop(),b=a.getWindow("VendorSearchGrid");b||(b=Ext.create("WJM.vendor.VendorGrid",{editAble:!1}),b=a.createWindow({id:"VendorSearchGrid",title:"供货商检索",width:600,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));b.show()},onSearchSaleClick:function(){var a=myDesktopApp.getDesktop(),b=a.getWindow("SaleSearchGrid");b||(b=Ext.create("WJM.sale.SaleGrid",
{editAble:!1,collapsedStatistics:!0}),b=a.createWindow({id:"SaleSearchGrid",title:"订单检索(拖动订单详细产品到产品列表区域)",width:800,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));b.show()},calculateTotal:function(){var a=0;this.down("gridpanel").getStore().data.each(function(b){b.set("total",b.get("num")*b.get("price_income"));a+=b.get("num")*b.get("price_income")});this.getForm().findField("all_purchase_price").setValue(a)},clearForm:function(){this.down("gridpanel").getStore().removeAll();
this.getForm().getFields().each(function(a){a.setValue("")});this.getForm().findField("oper_time").setValue(Ext.Date.format(new Date,"Y-m-d H:i:s"));this.getForm().findField("oper_name").setValue(window.user.userName);this.calculateTotal()},onGridBeforeEdit:function(a,b){if("vendortName"==b.field){var c=Ext.data.StoreManager.lookup("ProductVendorStore");c.getProxy().setExtraParam("product_id",b.record.getId());c.getProxy().setExtraParam("product_name",null);c.getProxy().setExtraParam("vendor_id",
null);c.getProxy().setExtraParam("vendor_name",null);c.load()}},onVendorSelect:function(a,b){var c=this.down("gridpanel").getView().getSelectionModel().getSelection()[0];c&&(c.set("provider_id",b[0].get("vendor_id")),c.set("vendortName",b[0].get("vendor_name")),c.set("price_income",b[0].get("price")))},onPurchaseProductLoad:function(a,b,c){if(c){var d=[],e=this;Ext.Array.each(a,function(a){var b=Ext.create("WJM.model.TProduct");b.setId(a.get("product_id"));b.set("code",a.get("product_code"));b.set("product_name",
a.get("product_name"));b.set("vendortName",e.record.get("provider_name"));b.set("provider_id",e.record.get("provider_id"));b.set("price_income",a.get("product_price"));b.set("num",a.get("product_num"));d.push(b)});this.down("gridpanel").getStore().loadRecords(d);this.calculateTotal()}},onProductLoad:function(a){var b=this.down("gridpanel").getStore();Ext.Array.each(a.records,function(a){b.getById(a.getId())||b.add(a)});this.calculateTotal();this.editor.startEdit(a.records[0],5)},onRemoveProductClick:function(){var a=
this.down("gridpanel"),b=a.getView().getSelectionModel().getSelection()[0];b?(a.getStore().remove(b),this.calculateTotal()):Ext.Msg.alert("提示","请选择产品")},beforeDestroy:function(){Ext.data.StoreManager.unregister(this.gridStoreId);this.callParent()}});
Ext.define("WJM.purchase.PurchaseFormModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TPurchase","WJM.model.TPurchaseProduct"],id:"purchase",init:function(){this.id=this.config.moduleId||"purchase";this.title=this.config.menuText||"P.O.(General)/订货"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.purchase.PurchaseForm"),b=a.createWindow({id:this.id,title:this.title,width:800,height:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,
layout:"fit",items:b}));b.down("form").clearForm();return b}});
Ext.define("WJM.purchase.PurchaseGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],collapsedStatistics:!1,layout:{type:"border",padding:5},defaults:{split:!0},deleteAble:!1,editAble:!1,cashAble:!1,receiveAble:!1,receiveEditing:null,purchaseStore:"PurchaseStore",purchaseProductStore:"PurchaseProductStore",onlyMy:!1,initComponent:function(){var a=[{xtype:"rownumberer"},{text:"barcode #/条码",dataIndex:"product_code",sortable:!0},{text:"item name/名称",dataIndex:"product_name",sortable:!0},{text:"unit price/单价",
dataIndex:"product_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"quantity/数量",dataIndex:"product_num",sortable:!0},{text:"sub total/小计",dataIndex:"sub_total",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"Actual received/已经收到",dataIndex:"actual_received",sortable:!0,xtype:"numbercolumn"}],b=[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"search",text:"打印",scope:this,handler:this.onSalePrintClick},{iconCls:"search",text:"清空",scope:this,handler:this.clearSearch}];
this.cashAble&&b.push({iconCls:"edit",text:"添加账单",scope:this,handler:this.onAddInvoiceClick},{iconCls:"edit",text:"付款",scope:this,handler:this.onCashClick});this.receiveAble&&(b.push({iconCls:"edit",text:"全部收货",scope:this,handler:this.onReceiveClick}),a.push({text:"received num/收到个数",dataIndex:"receive_num",sortable:!0,width:150,xtype:"numbercolumn",editor:{xtype:"numberfield",allowBlank:!1,allowDecimals:!1,minValue:1}},{xtype:"actioncolumn",text:"receive/收货",align:"center",width:100,items:[{width:66,
height:24,iconCls:"shouhuo-button",html:"<span>receive/收货</span>",tooltip:"receive/收货",handler:function(a,b){var e=a.getStore().getAt(b);e&&(1==e.get("if_stock")?Ext.Msg.alert("提示","此货物已经完全收获"):!e.get("receive_num")||0>=e.get("receive_num")||0>e.get("product_num")-e.get("receive_num")-e.get("actual_received")?Ext.Msg.alert("提示","请填写正确的收货数量"):this.receivePrdouct([e]))},scope:this}]}),this.receiveEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}));this.deleteAble&&b.push({iconCls:"remove",
text:"删除",scope:this,handler:this.onDeleteClick});this.editAble&&b.push({iconCls:"edit",text:"编辑",scope:this,handler:this.onEditClick});this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:b});b=[];this.onlyMy?b.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"oper_time_start",format:"Y-m-d"},{xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,name:"oper_time_end",format:"Y-m-d"},{xtype:"combobox",fieldLabel:"paid/付款",labelWidth:150,name:"paid",displayField:"name",
valueField:"value",store:"PurchasePaidStateStore",value:"-1"},{xtype:"combobox",fieldLabel:"check/确认到货",labelWidth:150,name:"if_stock",displayField:"name",valueField:"value",store:"PurchaseStockStateStore",value:"-1"},{xtype:"textfield",fieldLabel:"P.O. #/定单号",labelWidth:150,allowBlank:!0,name:"purchase_bill_code"},{name:"oper_id",value:window.user.userId,xtype:"hiddenfield"}):b.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"oper_time_start",format:"Y-m-d"},{xtype:"datefield",
fieldLabel:"end date/结束时间",labelWidth:150,name:"oper_time_end",format:"Y-m-d"},{xtype:"combobox",fieldLabel:"paid/付款",labelWidth:150,name:"paid",displayField:"name",valueField:"value",store:"PurchasePaidStateStore",value:"-1"},{xtype:"combobox",fieldLabel:"check/确认到货",labelWidth:150,name:"if_stock",displayField:"name",valueField:"value",store:"PurchaseStockStateStore",value:"-1"},{xtype:"combobox",fieldLabel:"Work ID/操作员",labelWidth:150,allowBlank:!0,name:"oper_id",displayField:"name",valueField:"id",
store:"EmployeeAllStore"},{xtype:"textfield",fieldLabel:"P.O. #/定单号",labelWidth:150,allowBlank:!0,name:"purchase_bill_code"});Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{name:"id",xtype:"hiddenfield"},{anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"采购单检索",layout:{columns:3,type:"table",tableAttrs:{style:{width:"100%"}}},bodyPadding:10,items:b},{store:this.purchaseStore,split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",
title:"采购单",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"P.O. #/定单号",dataIndex:"purchase_bill_code",sortable:!0},{text:"Work ID/操作员",dataIndex:"oper_name",sortable:!0},{text:"vendor name/供货商",dataIndex:"provider_name",sortable:!0},{text:"total/总计",dataIndex:"all_purchase_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"actual received amount/完成货总额",dataIndex:"actual_received_amount",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"Invoice/账单",dataIndex:"invoice_code",
sortable:!0},{text:"P.O. balance/订单余额",dataIndex:"balance",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"received status/收货状态",dataIndex:"if_stockStr",sortable:!0},{text:"payment status/付款状态",dataIndex:"paidStr",sortable:!0},{text:"date/时间",dataIndex:"oper_time",sortable:!0}],viewConfig:{plugins:[]},listeners:{selectionchange:function(a){if(a=a.getSelection()[0]){var b=Ext.data.StoreManager.lookup(this.purchaseProductStore);b.getProxy().setExtraParam("purchase_id",a.getId());b.load()}},
scope:this},bbar:Ext.create("Ext.PagingToolbar",{store:this.purchaseStore,displayInfo:!0,displayMsg:"显示采购单 {0} - {1} 总共 {2}",emptyMsg:"没有采购单数据"})},{store:this.purchaseProductStore,split:!0,disableSelection:!1,collapsible:!0,split:!0,loadMask:!0,height:150,autoScroll:!0,region:"south",multiSelect:!0,title:"采购单明细",xtype:"gridpanel",columns:a,viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ddGroup:"TProduct",enableDrop:!1,enableDrag:!0})]},plugins:this.receiveAble?[this.receiveEditing]:[]}]});
this.callParent();this.onSearchClick()},onSearchClick:function(){var a=this.down('form[title="采购单检索"]').getForm().getFieldValues(),b=Ext.data.StoreManager.lookup(this.purchaseStore);Ext.data.StoreManager.lookup(this.purchaseProductStore).removeAll();Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.loadPage(1)},clearSearch:function(){this.down('form[title="采购单检索"]').getForm().getFields().each(function(a){"if_stock"==a.getName()||"paid"==a.getName()?a.setValue("-1"):a.setValue("")})},
onCashClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];if(a)if(0==a.get("paid"))if(a.get("invoice_code")&&""!=a.get("invoice_code")){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.cash.PurchaseCashForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"付款",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","请先为此订单添加账单");else Ext.Msg.alert("提示",
"此采购单已经付款");else Ext.Msg.alert("提示","请选择采购单")},onAddInvoiceClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];if(a)if(!a.get("invoice_code")||""==a.get("invoice_code")){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.purchase.PurchaseInvoiceForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"添加账单",iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示",
"此订单已经添加了账单");else Ext.Msg.alert("提示","请选择采购单")},onReceiveClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0],b=this;a?0==a.get("if_stock")?Ext.Msg.confirm("提示","确定此采购单"+a.get("purchase_bill_code")+"收货么？",function(c){if("yes"==c){c=new Ext.data.proxy.Ajax({model:"WJM.model.TPurchase",url:"purchase_order.do?action=receivePurchase",reader:new Ext.data.reader.Json({type:"json",messageProperty:"msg"}),writer:Ext.create("WJM.FormWriter")});c.setExtraParam("id",
a.getId());var d=new Ext.data.Operation({action:"update"});c.read(d,function(){d.wasSuccessful()?(Ext.Msg.alert("提示","收货成功"),Ext.data.StoreManager.lookup(this.purchaseStore).loadPage(1)):Ext.Msg.alert("提示","收货失败，请稍候再试")},b)}},this):Ext.Msg.alert("提示","此采购单已经收货"):Ext.Msg.alert("提示","请选择采购单")},receivePrdouct:function(a){var b=[];Ext.Array.each(a,function(a){1!=a.get("if_stock")&&b.push(a.getData())});var c=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];if(0<b.length&&
c){a=new Ext.data.proxy.Ajax({model:"WJM.model.TPurchase",url:"purchase_order.do?action=checkPurchase",reader:new Ext.data.reader.Json({type:"json",messageProperty:"msg"}),writer:Ext.create("WJM.FormWriter")});a.setExtraParam("purchaseProducts",Ext.JSON.encode(b));a.setExtraParam("id",c.getId());var d=new Ext.data.Operation({action:"update"});a.read(d,function(){if(d.wasSuccessful()){Ext.Msg.alert("提示","收货成功");var a=Ext.data.StoreManager.lookup(this.purchaseProductStore);a.getProxy().setExtraParam("purchase_id",
c.getId());a.load();Ext.data.StoreManager.lookup(this.purchaseStore).load()}else Ext.Msg.alert("提示","收货失败，请稍候再试")},this)}},onSaveSuccess:function(a){a&&a.ownerCt.destroy();Ext.data.StoreManager.lookup(this.purchaseStore).loadPage(1);this.show()},onDeleteClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];a?a.canDelete()?Ext.Msg.confirm("提示","确定要删除此采购单么？",function(b){"yes"==b&&Ext.data.StoreManager.lookup(this.purchaseStore).remove(a)},this):Ext.Msg.alert("提示",
"此采购单已经收货或者已经付款、或者已经绑定账单，无法删除！"):Ext.Msg.alert("提示","请选择产品")},onSalePrintClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];a?window.open(location.context+"/purchase_order.do?action=print_bill&id="+a.getId(),"_blank"):Ext.Msg.alert("提示","请选择产品")},onEditClick:function(){var a=this.down('grid[title="采购单"]').getView().getSelectionModel().getSelection()[0];if(a)if(a.canEdit()){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.purchase.PurchaseForm",{listeners:{saveSuccess:this.onSaveSuccess,
scope:this},record:a});win=b.createWindow({title:"编辑采购单",iconCls:"icon-grid",animCollapse:!1,width:800,height:500,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","此采购不可以编辑。");else Ext.Msg.alert("提示","请选择采购")}});
Ext.define("WJM.purchase.PurchaseInvoiceForm",{extend:"Ext.form.Panel",record:null,bodyPadding:10,closeAction:"destroy",initComponent:function(){Ext.applyIf(this,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},{xtype:"hiddenfield",dataIndex:"provider_id",name:"provider_id"},{name:"provider_name",fieldLabel:"Vendor Name/商家名",readOnly:!0},{name:"purchase_bill_code",fieldLabel:"P.O. #/定单号",readOnly:!0},{name:"invoice_code",fieldLabel:"Invoice Number/帐单编号",
readOnly:!1,allowBlank:!1},{name:"amout",fieldLabel:"Invoice Amout/帐单金额",readOnly:!1,xtype:"adnumberfield",allowBlank:!1},{name:"invoiceDate",fieldLabel:"Invoice Date/帐单日期",value:Ext.Date.format(new Date,"Y-m-d H:i:s")},{name:"description",fieldLabel:"Invoice Decription/帐单描述",xtype:"textareafield"}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick}]}]});this.callParent(arguments);this.record&&"WJM.model.TPurchase"==this.record.modelName&&
(this.getForm().findField("provider_id").setValue(this.record.get("provider_id")),this.getForm().findField("purchase_bill_code").setValue(this.record.get("purchase_bill_code")),this.getForm().findField("amout").setValue(this.record.get("actual_received_amount")),this.getForm().findField("provider_name").setValue(this.record.get("provider_name")),this.getForm().findField("provider_id").setValue(this.record.get("provider_id")))},onSaveClick:function(){var a=this;this.getForm().isValid()&&this.submit({url:"invoice.do?action=save",
success:function(){Ext.Msg.alert("提示","保存成功");a.fireEvent("saveSuccess",a)},failure:function(a,c){Ext.Msg.alert("提示",c.result.msg||"保存失败，请稍候重试")}})}});
Ext.define("WJM.purchase.PurchaseReportModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TPurchase","WJM.model.TPurchaseProduct"],id:"purchasedetail",init:function(){this.id=this.config.moduleId||"purchasedetail";this.title=this.config.menuText||"purchase detail/购买报表"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.purchase.PurchaseGrid",{editAble:!1,receiveAble:!1,cashAble:!1,deleteAble:!1}),b=a.createWindow({id:this.id,title:this.title,
width:980,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.sale.MyQuoteModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSale","WJM.model.TSaleProduct"],id:"myquote",init:function(){this.id=this.config.moduleId||"myquote";this.title=this.config.menuText||"my quote/我的报价"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.sale.SaleQuoteGrid",{deleteAble:!0,editAble:!0,onlyMy:!1,title:"报价单"}),b=a.createWindow({id:this.id,title:this.title,width:980,height:600,iconCls:"icon-grid",animCollapse:!1,
constrainHeader:!0,layout:"fit",items:[b]}));return b}});
Ext.define("WJM.sale.MySaleModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSale","WJM.model.TSaleProduct"],id:"mysale",init:function(){this.id=this.config.moduleId||"mysale";this.title=this.config.menuText||"my sale/我的销售"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.sale.SaleGrid",{deleteAble:!0,editAble:!0,onlyMy:!1,saleStore:"SaleMyStore",saleProductStore:"SaleProductMyStore",reciveAble:!0,title:"销售订单"}),b=a.createWindow({id:this.id,
title:this.title,width:980,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));return b}});
Ext.define("WJM.sale.SaleBetweenReportModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSaleTop"],id:"reportbetween",init:function(){this.id=this.config.moduleId||"reportbetween";this.title=this.config.menuText||"Sales Report Between/自选销售报表"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.sale.SaleTopGrid",{reportType:"bettenSaleReport"}),b=a.createWindow({id:this.id,title:this.title,width:500,height:500,iconCls:"icon-grid",animCollapse:!1,
constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.sale.SaleDailyReportModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSaleTop"],id:"dailyreport",init:function(){this.id=this.config.moduleId||"dailyreport";this.title=this.config.menuText||"sale detail/销售报表"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.sale.SaleTopGrid",{reportType:"daySaleReport"}),b=a.createWindow({id:this.id,title:this.title,width:500,height:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,
layout:"fit",items:b}));return b}});
Ext.define("WJM.sale.SaleForm",{extend:"Ext.form.Panel",requires:["WJM.model.TSale","WJM.model.TProduct"],bodyPadding:10,autoScroll:!0,record:null,initComponent:function(){var a=this;this.gridStoreId=Ext.Number.randomInt(1E6,9999999).toString();Ext.create("Ext.data.Store",{storeId:this.gridStoreId,autoLoad:!1,model:"WJM.model.TProduct"});var b=[{xtype:"rownumberer"},{text:"barcode #/条码",dataIndex:"code",sortable:!0,width:100},{text:"items id/助记符",dataIndex:"product_id",sortable:!0,width:100},{text:"description 1",
dataIndex:"product_name",sortable:!0,width:200,editor:{xtype:"textfield",allowBlank:!1}},{text:"quantity/数量",dataIndex:"num",sortable:!0,xtype:"numbercolumn",format:"0,000",editor:{xtype:"numberfield",allowBlank:!1,allowDecimals:!1}},{text:"unit price/单价",dataIndex:"price_simgle",sortable:!0,xtype:"numbercolumn",format:"$0.00",editor:{xtype:"adnumberfield",allowBlank:!1}},{text:"discount price/折扣价",dataIndex:"agio_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"discount percent/折扣百分比",
dataIndex:"agio",sortable:!0,xtype:"numbercolumn",format:"0.0%",editor:{xtype:"adnumberfield",allowBlank:!1}},{text:"sub total/小计",dataIndex:"total",sortable:!0,xtype:"numbercolumn",format:"$0.00"}];this.record||b.push({xtype:"actioncolumn",text:"使用批发价",align:"center",width:174,items:[{width:66,height:24,iconCls:"pifa-button",html:"<span>使用批发价</span>",tooltip:"使用批发价",handler:function(b,d){var e=b.getStore().getAt(d);e.get("old_wholesale")||(e.set("old_wholesale",e.get("price_wholesale")),e.set("old_simgle",
e.get("price_simgle")));var f=Ext.Msg.prompt("approver","请输入优惠确认人code:",function(b,c){b=="ok"&&(new Ext.data.proxy.Ajax({model:"WJM.model.TEmployee",url:"sale.do?action=checkApprover",reader:new Ext.data.reader.Json({type:"json",messageProperty:"msg"}),extraParams:{confirm_code:c},writer:Ext.create("WJM.FormWriter")})).read(new Ext.data.Operation({}),function(a){a.success?e.set("price_simgle",e.get("old_wholesale")):Ext.Msg.alert("提示",a.error);this.calculateTotal()},a)});Ext.dom.Element.get(f.down("textfield").getInputId()).dom.type=
"password";this.calculateTotal()},scope:this},{width:24,height:66,iconCls:"linshou-button",html:"<span>使用零售价</span>",tooltip:"使用零售价",handler:function(a,b){var e=a.getStore().getAt(b);e.get("old_wholesale")||(e.set("old_wholesale",e.get("price_wholesale")),e.set("old_simgle",e.get("price_simgle")));e.set("price_simgle",e.get("old_simgle"));this.calculateTotal()},scope:this}]});this.editor=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1,listeners:{edit:a.calculateTotal,scope:a,beforeedit:a.onBeforeEdit}});
Ext.applyIf(a,{defaults:{xtype:"textfield",anchor:"98%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},{name:"type",xtype:"hiddenfield"},{xtype:"container",layout:{columns:2,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"50%"}}},items:[Ext.create("WJM.product.ProductQuickSearchForm",{anchor:"100%",height:50,listeners:{onProductLoad:a.onProductLoad,scope:a}}),Ext.create("WJM.customer.CustomerQuickSearchForm",{anchor:"100%",height:50,listeners:{onProductLoad:a.onCustomerLoad,
scope:a}})]},{anchor:"98% -560",minHeight:300,disableSelection:!1,loadMask:!0,xtype:"gridpanel",columns:b,plugins:[this.editor],store:this.gridStoreId,viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop",ddGroup:"TProduct",enableDrop:!0,enableDrag:!1})],listeners:{drop:function(a,b){for(var e=0;e<b.records.length;e++){var f=b.records[e];f.set("num",null);f.set("agio",0)}this.calculateTotal()},beforedrop:function(b,d){d.copy=!0;var e=a.down("gridpanel").getStore();d.records=
Ext.Array.filter(d.records,function(a){return(a=e.getById(a.getId()))?(a.set("num",a.get("num")+1),!1):!0});this.calculateTotal()},scope:a}}},{title:"customer/客户",xtype:"fieldset",collapsible:!0,collapsed:!1,layout:{columns:2,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"50%"}}},defaults:{allowBlank:!0,xtype:"textfield",width:"90%",labelWidth:120},items:[{fieldLabel:"Phone/电话",name:"buyer_mobile"},{fieldLabel:"name/客户名称",name:"buyer_name"},{fieldLabel:"address/客户地址",name:"buyer_address"},
{fieldLabel:"City/城市",name:"buyer_city"},{fieldLabel:"State/州",name:"buyer_state"},{fieldLabel:"Zip Code/邮编",name:"buyer_postCode"},{name:"buyer_id",allowBlank:!1,xtype:"hidden"},{name:"buyer_code",allowBlank:!1,xtype:"hidden"}]},{name:"discount",allowBlank:!0,xtype:"hiddenfield",anchor:"100%"},{title:"Discount/优惠",xtype:"fieldset",collapsible:!0,collapsed:!1,layout:{columns:4,type:"table",tableAttrs:{style:{width:"100%"}}},items:[{fieldLabel:"Discount Percent/优惠百分比",name:"discountpercent",allowBlank:!0,
xtype:"adnumberfield",anchor:"100%",labelWidth:150,readOnly:!1,minValue:0,value:0,colspan:2,format:"0.0000",decimalPrecision:4,listeners:{change:a.calculateTotal,scope:a}},{fieldLabel:"approver id/优惠确认人",name:"confirm_code",allowBlank:!0,xtype:"textfield",anchor:"100%",labelWidth:150,readOnly:!1,colspan:2,inputType:"password"},{xtype:"button",anchor:"100%",text:"No discount(With All Tax)/不优惠(含所有税)",listeners:{click:function(){this.getForm().findField("discount").setValue(0);this.getForm().findField("discountpercent").setValue(0)},
scope:a}},{xtype:"button",anchor:"100%",text:"No tax/不交税",listeners:{click:function(){var a=this.getForm().findField("tax").getValue(),b=this.getForm().findField("sub_total").getValue();this.getForm().findField("discount").setValue(a);this.getForm().findField("discountpercent").setValue(100*(a/b))},scope:a}},{xtype:"button",anchor:"100%",text:"5% Discount Percent/优惠5%",listeners:{click:function(){this.getForm().findField("discount").setValue(0.05*this.getForm().findField("sub_total").getValue());
this.getForm().findField("discountpercent").setValue(5)},scope:a}}]},{title:"Payment Delivery/支付与送货",xtype:"fieldset",layout:{columns:2,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"50%"}}},allowBlank:!1,items:[{xtype:"combobox",fieldLabel:"Payment Method/支付方式",labelWidth:170,name:"payment",displayField:"name",valueField:"value",store:"SalePaymentMethodStore",value:"Cash",allowBlank:!1},{xtype:"combobox",fieldLabel:"Delivery Method/送货方式",labelWidth:170,name:"send_type",displayField:"name",
valueField:"value",store:"SaleSendMethodStore",value:"送货",allowBlank:!1}]},{xtype:"container",padding:"10 0 0 0",layout:{columns:2,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"50%"}}},items:[{xtype:"textfield",name:"oper_name",labelWidth:110,width:"90%",fieldLabel:"Worker ID/操作员",allowBlank:!1,readOnly:!0,value:window.user.userName},{xtype:"textfield",name:"oper_time",fieldLabel:"date/时间",width:"90%",labelWidth:110,allowBlank:!1,readOnly:!0,value:Ext.Date.format(new Date,
"Y-m-d H:i:s")},{name:"sub_total",fieldLabel:"sub total/合计",allowBlank:!1,labelWidth:110,width:"90%",readOnly:!0,xtype:"adnumberfield"},{name:"tax",fieldLabel:"Tax/税("+(100*window.invoiceTax).toFixed(3)+"%)",allowBlank:!1,labelWidth:110,width:"90%",readOnly:!0,xtype:"adnumberfield"},{name:"all_price",fieldLabel:"Total/总计",allowBlank:!1,labelWidth:110,width:"90%",readOnly:!0,xtype:"adnumberfield"}]},{name:"remark",fieldLabel:"Remark/备注",allowBlank:!0,xtype:"textareafield",rows:2,labelWidth:110}],dockedItems:[{xtype:"toolbar",
dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存订单",scope:this,handler:this.onSaveClick},{xtype:"button",iconCls:"save",text:"保存报价单",scope:this,handler:this.onSaveQuoteClick},{xtype:"button",iconCls:"search",text:"搜索产品",scope:this,handler:this.onProductSearchClick},{xtype:"button",iconCls:"search",text:"搜索客户",scope:this,handler:this.onCustomerSearchClick},{xtype:"button",iconCls:"search",text:"清空",scope:this,handler:this.clearForm},{xtype:"button",iconCls:"remove",text:"删除产品",scope:this,
handler:this.onRemoveProductClick},{xtype:"button",iconCls:"add",text:"添加临时产品",scope:this,handler:this.onAddProductClick}]}]});a.callParent(arguments);a.on("afterrender",this.initDragDorp,a);this.record&&(a.loadRecord(this.record),b=Ext.data.StoreManager.lookup("SaleProductStore"),b.getProxy().setExtraParam("sale_id",this.record.getId()),b.load({scope:this,callback:this.onSaleProductLoad}))},initDragDorp:function(){var a=this;this.dragDorp=Ext.create("Ext.dd.DropTarget",this.down('fieldset[title="customer/客户"]').getEl().dom,
{ddGroup:"TCustomer",notifyEnter:function(){a.stopAnimation();a.getEl().highlight()},notifyDrop:function(b){a.setCustomer(b.dragData.records[0]);return!0}})},setCustomer:function(a){this.customer=a;this.getForm().findField("buyer_name").setValue(a.get("shortName"));this.getForm().findField("buyer_address").setValue(a.get("address"));this.getForm().findField("buyer_state").setValue(a.get("state"));this.getForm().findField("buyer_city").setValue(a.get("city"));this.getForm().findField("buyer_postCode").setValue(a.get("postCode"));
this.getForm().findField("buyer_mobile").setValue(a.get("mobile"));this.getForm().findField("buyer_code").setValue(a.get("code"));this.getForm().findField("buyer_id").setValue(a.getId());this.getForm().findField("payment").setValue("Credit Account")},onSaveClick:function(){this.getForm().findField("type").setValue(0);this.customer&&0<this.customer.get("credit_Line")&&0>this.customer.get("credit_Line")+this.customer.get("leav_money")-this.customer.get("balance")-this.getForm().findField("all_price").getValue()?
Ext.Msg.alert("提示","此用户预付款："+this.customer.get("leav_money")+" 已经欠款"+this.customer.get("balance")+" 信用额度："+this.customer.get("credit_Line")+" 应付款："+this.getForm().findField("all_price").getValue()):this.saveForm()},onSaveQuoteClick:function(){this.getForm().findField("type").setValue(1);this.saveForm()},saveForm:function(){var a=this.getForm(),b=this,c=this.down("gridpanel").getStore().data,d=[];this.calculateTotal();c.each(function(a){d.push(a.getData())});a.isValid()&&(0==d.length?Ext.Msg.alert("提示",
"请选择产品"):this.submit({url:"sale.do?action=sale_submit",params:{saleProducts:Ext.JSON.encode(d)},success:function(a,c){var d=c.result,h="";Ext.Array.each(d.listData,function(a){h+='<span style="color:#ff0000;">,'+a.product_name+"可能库存不足</span>"});Ext.Msg.alert("提示","保存成功"+h);b.clearForm();window.open(location.context+"/sale.do?action=re_print&id="+d.saleId,"_blank");b.fireEvent("saveSuccess",b)},failure:function(a,b){Ext.Msg.alert("提示",b.result.msg||"保存失败，请稍候重试")}}))},onProductSearchClick:function(){var a=
myDesktopApp.getDesktop(),b=a.getWindow("productsearch");b||(b=Ext.create("WJM.product.ProductGrid",{editAble:!1}),b=a.createWindow({id:"productsearch",title:"search/产品搜索",width:600,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));b.show()},onCustomerSearchClick:function(){var a=myDesktopApp.getDesktop(),b=a.getWindow("customersearch");b||(b=Ext.create("WJM.customer.CustomerGrid",{editAble:!0}),b=a.createWindow({id:"customersearch",title:"search/客户搜索",width:600,
height:800,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));b.show()},calculateTotal:function(){var a=0;this.down("gridpanel").getStore().data.each(function(b){var d=Ext.util.Format.number(b.get("price_simgle")*(1-b.get("agio")/100),"0.00");b.set("agio_price",d);b.set("total",b.get("num")*d);a+=b.get("total")});this.getForm().findField("sub_total").setValue(a);this.getForm().findField("tax").setValue(a*window.invoiceTax);var b=Number(this.getForm().findField("discountpercent").getValue())/
100;this.getForm().findField("discount").setValue(a*b);this.getForm().findField("all_price").setValue(a*(1+Number(window.invoiceTax))-Number(this.getForm().findField("discount").getValue()))},clearForm:function(){this.down("gridpanel").getStore().removeAll();this.customer=null;this.getForm().getFields().each(function(a){a.setValue("")});this.getForm().findField("oper_time").setValue(Ext.Date.format(new Date,"Y-m-d H:i:s"));this.getForm().findField("oper_name").setValue(window.user.userName);this.getForm().findField("payment").setValue(Ext.data.StoreManager.lookup("SalePaymentMethodStore").getAt(0).get("value"));
this.getForm().findField("send_type").setValue(Ext.data.StoreManager.lookup("SaleSendMethodStore").getAt(0).get("value"));this.calculateTotal()},onSaleProductLoad:function(a,b,c){if(c){var d=[];Ext.Array.each(a,function(a){var b=Ext.create("WJM.model.TProduct");b.setId(a.get("product_id"));b.set("code",a.get("product_code"));b.set("product_name",a.get("product_name"));b.set("agio_price",a.get("agio_price"));b.set("agio",a.get("agio"));b.set("product_id",a.get("productid"));b.set("price_simgle",a.get("product_price"));
b.set("num",a.get("product_num"));d.push(b)});this.down("gridpanel").getStore().loadRecords(d);this.calculateTotal()}},onProductLoad:function(a){var b=this.down("gridpanel").getStore();Ext.Array.each(a.records,function(a){var d=b.getById(a.getId());d?d.set("num",d.get("num")+1):(a.set("num",null),a.set("agio",0),b.add(a))});0<a.records.length&&this.editor.startEdit(a.records[0],4);this.calculateTotal()},onRemoveProductClick:function(){var a=this.down("gridpanel"),b=a.getView().getSelectionModel().getSelection()[0];
b?(a.getStore().remove(b),this.calculateTotal()):Ext.Msg.alert("提示","请选择产品")},onAddProductClick:function(){var a=this.down("gridpanel"),b=Ext.create("WJM.model.TProduct");b.setId(-1);b.set("num",null);b.set("code","999999");b.set("product_id","999999");b.set("product_name","");b.set("price_simgle",null);b.set("agio",0);a.getStore().add(b);this.calculateTotal();this.editor.startEdit(b,3)},onCustomerLoad:function(a){var b=this;Ext.Array.each(a.records,function(a){b.setCustomer(a)})},onBeforeEdit:function(a,
b){return"product_name"==b.field||"price_simgle"==b.field?-1==b.record.getId()?!0:!1:!0},beforeDestroy:function(){Ext.destroy(this.dragDorp);Ext.data.StoreManager.unregister(this.gridStoreId);this.callParent()}});
Ext.define("WJM.sale.SaleFormModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSale","WJM.model.TSaleProduct"],id:"sale",init:function(){this.id=this.config.moduleId||"sale";this.title=this.config.menuText||"sale/销售"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.sale.SaleForm"),b=a.createWindow({id:this.id,title:this.title,width:900,height:750,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:b}));b.down("form").clearForm();
return b}});
Ext.define("WJM.sale.SaleGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],collapsedStatistics:!1,layout:{type:"border",padding:5},defaults:{split:!0},closeAction:"destroy",saleStore:"SaleStore",saleProductStore:"SaleProductStore",deleteAble:!1,editAble:!1,cashAble:!1,reciveAble:!1,onlyMy:!1,rmaAble:!1,initComponent:function(){var a=[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"search",text:"打印订单",scope:this,handler:this.onSalePrintClick},{iconCls:"search",text:"清空",
scope:this,handler:this.clearSearch}];this.deleteAble&&a.push({iconCls:"remove",text:"删除",scope:this,handler:this.onDeleteClick});this.editAble&&a.push({iconCls:"edit",text:"编辑",scope:this,handler:this.onEditClick});this.reciveAble&&a.push({iconCls:"search",text:"打印出货单",scope:this,handler:this.onPackePrintClick});this.cashAble&&a.push({iconCls:"edit",text:"收款",scope:this,handler:this.onCashClick});this.rmaAble&&a.push({iconCls:"search",text:"打印退货单",scope:this,handler:this.onRmaPrintClick});var b=
[];this.onlyMy?b.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"oper_time_start",format:"Y-m-d"},{xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,name:"oper_time_end",format:"Y-m-d"},{xtype:"combobox",fieldLabel:"sate/订单状态",labelWidth:150,name:"if_cashed",displayField:"name",valueField:"value",store:"SaleCashStateStore",value:"-1"},{xtype:"textfield",fieldLabel:"receive #/销售单号",labelWidth:150,allowBlank:!0,name:"sale_bill_code"},{xtype:"textfield",fieldLabel:"invoice #/invoice单号",
labelWidth:150,allowBlank:!0,name:"invoicecode"},{name:"oper_id",value:window.user.userId,xtype:"hiddenfield"}):b.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"oper_time_start",format:"Y-m-d"},{xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,name:"oper_time_end",format:"Y-m-d"},{xtype:"combobox",fieldLabel:"sate/订单状态",labelWidth:150,name:"if_cashed",displayField:"name",valueField:"value",store:"SaleCashStateStore",value:"-1"},{xtype:"combobox",fieldLabel:"Work ID/操作员",
labelWidth:150,allowBlank:!0,name:"oper_id",displayField:"name",valueField:"id",store:"EmployeeAllStore"},{xtype:"textfield",fieldLabel:"invoice #/invoice单号",labelWidth:150,allowBlank:!0,name:"invoicecode"},{xtype:"textfield",fieldLabel:"name/客户名称",labelWidth:150,allowBlank:!0,name:"buyer_name"},{xtype:"textfield",fieldLabel:"address/客户地址",labelWidth:150,allowBlank:!0,name:"buyer_address"},{xtype:"textfield",fieldLabel:"Phone/电话",labelWidth:150,allowBlank:!0,name:"buyer_mobile"});this.editTopBar=
Ext.create("Ext.toolbar.Toolbar",{items:a});Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{anchor:"100%",height:130,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"订单检索",layout:{columns:3,type:"table",tableAttrs:{style:{width:"100%"}}},bodyPadding:10,items:b},{store:this.saleStore,split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",title:"订单",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"receive #/销售单",dataIndex:"sale_bill_code",sortable:!0},
{text:"invoice #/invoice单号",dataIndex:"invoice",sortable:!0},{text:"saleman/销售员",dataIndex:"oper_name",sortable:!0},{text:"phone/电话",dataIndex:"buyer_mobile",sortable:!0},{text:"customer/客户",dataIndex:"buyer_name",sortable:!0},{text:"total/合计",dataIndex:"all_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"balance/余额",dataIndex:"balance",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"state/状态",dataIndex:"if_cashedStr",sortable:!0},{text:"date/时间",dataIndex:"oper_time",sortable:!0},
{text:"tax/税",dataIndex:"tax",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"payment/支付方式",dataIndex:"payment",sortable:!0},{text:"sub total/小计",dataIndex:"sub_total",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"discount/优惠",dataIndex:"discount",sortable:!0,xtype:"numbercolumn",format:"$0.00"}],viewConfig:{plugins:[]},listeners:{selectionchange:function(a){if(a=a.getSelection()[0]){var b=Ext.data.StoreManager.lookup(this.saleProductStore);b.getProxy().setExtraParam("sale_id",a.getId());
b.load()}},scope:this},bbar:Ext.create("Ext.PagingToolbar",{store:this.saleStore,displayInfo:!0,displayMsg:"显示订单 {0} - {1} 总共 {2}",emptyMsg:"没有订单数据"})},{region:"south",split:!0,height:150,layout:{type:"border",padding:5},items:[{store:this.saleProductStore,split:!0,disableSelection:!1,collapsible:!0,split:!0,loadMask:!0,height:150,autoScroll:!0,region:"center",multiSelect:!0,title:"订单明细",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"barcode #/条码",dataIndex:"product_code",sortable:!0},{text:"item name/名称",
dataIndex:"product_name",sortable:!0},{text:"unit price/单价",dataIndex:"agio_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"quantity/数量",dataIndex:"product_num",sortable:!0},{text:"sub total/小计",dataIndex:"sub_total2",sortable:!0,xtype:"numbercolumn"},{text:"RMAed credit quantity/已退货无损数量",dataIndex:"credit_num",sortable:!0,xtype:"numbercolumn"},{text:"RMAed damage quantity/已退货损坏数量",dataIndex:"damage_num",sortable:!0,xtype:"numbercolumn"}],viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",
{ddGroup:"TProduct",enableDrop:!1,enableDrag:!0})]}},{xtype:"form",title:"销售统计",region:"east",width:250,collapsible:!0,split:!0,collapsed:this.collapsedStatistics,defaults:{xtype:"textfield",anchor:"100%",labelWidth:100,bodyPadding:10},items:[{fieldLabel:"total sales/次数",name:"total_sales",readOnly:!0},{fieldLabel:"amount/总计",name:"amount",readOnly:!0,xtype:"adnumberfield"}]}]}]});Ext.data.StoreManager.lookup(this.saleStore).on("load",this.onDataRefresh,this);this.callParent();this.onSearchClick()},
onSearchClick:function(){var a=this.down('form[title="订单检索"]').getForm().getFieldValues(),b=Ext.data.StoreManager.lookup(this.saleStore);Ext.data.StoreManager.lookup(this.saleProductStore).removeAll();Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.loadPage(1)},clearSearch:function(){this.down('form[title="订单检索"]').getForm().getFields().each(function(a){"if_cashed"==a.getName()?a.setValue("-1"):a.setValue("")})},onDataRefresh:function(){var a=Ext.data.StoreManager.lookup(this.saleStore),
b=this.down('form[title="销售统计"]');b&&(b=b.getForm(),b.findField("total_sales").setValue(a.getCount()),b.findField("amount").setValue(a.sum("all_price")))},onCashClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];if(a)if(0==a.get("if_cashed"))if("Credit Account"!=a.get("payment")){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.cash.SaleCashForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"收款",iconCls:"icon-grid",
animCollapse:!1,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","此订单为会员订单，请到客户管理模块收款");else Ext.Msg.alert("提示","此订单已经收款");else Ext.Msg.alert("提示","请选择订单")},onSaveSuccess:function(a){a.ownerCt.destroy();Ext.data.StoreManager.lookup(this.saleStore).loadPage(1);this.show()},onDeleteClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];a?a.canDelete()?Ext.Msg.confirm("提示","确定要删除此订单么？",function(b){"yes"==b&&Ext.data.StoreManager.lookup(this.saleStore).remove(a)},
this):Ext.Msg.alert("提示","此订单不可以删除！"):Ext.Msg.alert("提示","请选择产品")},onRmaPrintClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];a&&a.isRma()?window.open(location.context+"/sale.do?action=rma_print&id="+a.getId(),"_blank"):Ext.Msg.alert("提示","请选择RMA的订单")},onSalePrintClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];a?window.open(location.context+"/sale.do?action=re_print&id="+a.getId(),"_blank"):Ext.Msg.alert("提示",
"请选择订单")},onPackePrintClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];a?0==a.get("if_cashed")?Ext.Msg.alert("提示","此订单未完全收款，无法打印出货单"):window.open(location.context+"/sale.do?action=packing_print&id="+a.getId(),"_blank"):Ext.Msg.alert("提示","请选择订单")},onEditClick:function(){var a=this.down('grid[title="订单"]').getView().getSelectionModel().getSelection()[0];if(a)if(a.canEdit()){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.sale.SaleForm",{listeners:{saveSuccess:this.onSaveSuccess,
scope:this},record:a});win=b.createWindow({title:"编辑订单",iconCls:"icon-grid",animCollapse:!1,width:800,height:750,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","此订单不可以编辑。");else Ext.Msg.alert("提示","请选择订单")}});
Ext.define("WJM.sale.SaleMonthlyReportModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSaleTop"],id:"monthlyreport",init:function(){this.id=this.config.moduleId||"monthlyreport";this.title=this.config.menuText||"monthly report/每月报表"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.sale.SaleTopGrid",{reportType:"monthlySaleReport"}),b=a.createWindow({id:this.id,title:this.title,width:500,height:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,
layout:"fit",items:b}));return b}});
Ext.define("WJM.sale.SaleQuoteGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],collapsedStatistics:!1,layout:{type:"border",padding:5},defaults:{split:!0},saleStore:"SaleMyQuoteStore",saleProductStore:"SaleQuoteProductMyStore",deleteAble:!1,editAble:!1,onlyMy:!1,initComponent:function(){var a=[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"search",text:"打印报价单",scope:this,handler:this.onSalePrintClick},{iconCls:"search",text:"清空",scope:this,handler:this.clearSearch}];
this.deleteAble&&a.push({iconCls:"remove",text:"删除",scope:this,handler:this.onDeleteClick});this.editAble&&a.push({iconCls:"edit",text:"编辑",scope:this,handler:this.onEditClick});var b=[];this.onlyMy?b.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"oper_time_start",format:"Y-m-d"},{xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,name:"oper_time_end",format:"Y-m-d"},{xtype:"textfield",fieldLabel:"receive #/销售单号",labelWidth:150,allowBlank:!0,name:"sale_bill_code"},
{xtype:"textfield",fieldLabel:"invoice #/invoice单号",labelWidth:150,allowBlank:!0,name:"invoicecode"},{name:"oper_id",value:window.user.userId,xtype:"hiddenfield"}):b.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"oper_time_start",format:"Y-m-d"},{xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,name:"oper_time_end",format:"Y-m-d"},{xtype:"combobox",fieldLabel:"Work ID/操作员",labelWidth:150,allowBlank:!0,name:"oper_id",displayField:"name",valueField:"id",store:"EmployeeAllStore"},
{xtype:"textfield",fieldLabel:"receive #/销售单号",labelWidth:150,allowBlank:!0,name:"sale_bill_code"},{xtype:"textfield",fieldLabel:"invoice #/invoice单号",labelWidth:150,allowBlank:!0,name:"invoicecode"});this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:a});Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"报价单检索",layout:{columns:3,type:"table",tableAttrs:{style:{width:"100%"}}},bodyPadding:10,
items:b},{store:this.saleStore,split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",title:"报价单",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"receive #/销售单",dataIndex:"sale_bill_code",sortable:!0},{text:"saleman/销售员",dataIndex:"oper_name",sortable:!0},{text:"customer/客户",dataIndex:"buyer_code",sortable:!0},{text:"customer tel/客户电话",dataIndex:"buyer_mobile",width:150,sortable:!0},{text:"sub total/小计",dataIndex:"sub_total",sortable:!0,xtype:"numbercolumn",format:"$0.00"},
{text:"tax/税",dataIndex:"tax",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"total/合计",dataIndex:"all_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"date/时间",dataIndex:"oper_time",sortable:!0}],viewConfig:{plugins:[]},listeners:{selectionchange:function(a){if(a=a.getSelection()[0]){var b=Ext.data.StoreManager.lookup(this.saleProductStore);b.getProxy().setExtraParam("sale_id",a.getId());b.load()}},scope:this},bbar:Ext.create("Ext.PagingToolbar",{store:this.saleStore,displayInfo:!0,
displayMsg:"显示报价单 {0} - {1} 总共 {2}",emptyMsg:"没有报价单数据"})},{store:this.saleProductStore,split:!0,disableSelection:!1,collapsible:!0,split:!0,loadMask:!0,height:150,autoScroll:!0,region:"south",multiSelect:!0,title:"报价单明细",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"barcode #/条码",dataIndex:"product_code",sortable:!0},{text:"item name/名称",dataIndex:"product_name",sortable:!0},{text:"unit price/单价",dataIndex:"product_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"quantity/数量",
dataIndex:"product_num",sortable:!0},{text:"sub total/小计",dataIndex:"sub_total",sortable:!0,xtype:"numbercolumn",format:"$0.00"}],viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ddGroup:"TProduct",enableDrop:!1,enableDrag:!0})]}}]});this.callParent();this.onSearchClick()},onSearchClick:function(){var a=this.down('form[title="报价单检索"]').getForm().getFieldValues(),b=Ext.data.StoreManager.lookup(this.saleStore);Ext.data.StoreManager.lookup(this.saleProductStore).removeAll();Ext.Object.each(a,
function(a,d){b.getProxy().setExtraParam(a,d)});b.loadPage(1)},clearSearch:function(){this.down('form[title="报价单检索"]').getForm().getFields().each(function(a){"if_cashed"==a.getName()?a.setValue("-1"):a.setValue("")})},onDeleteClick:function(){var a=this.down('grid[title="报价单"]').getView().getSelectionModel().getSelection()[0];a?a.canDelete()?Ext.Msg.confirm("提示","确定要删除此报价单么？",function(b){"yes"==b&&Ext.data.StoreManager.lookup(this.saleStore).remove(a)},this):Ext.Msg.alert("提示","此报价单不可以删除！"):Ext.Msg.alert("提示",
"请选择产品")},onSalePrintClick:function(){var a=this.down('grid[title="报价单"]').getView().getSelectionModel().getSelection()[0];a?window.open(location.context+"/sale.do?action=re_print&id="+a.getId(),"_blank"):Ext.Msg.alert("提示","请选择产品")},onEditClick:function(){var a=this.down('grid[title="报价单"]').getView().getSelectionModel().getSelection()[0];if(a)if(a.canEdit()){var b=myDesktopApp.getDesktop(),a=Ext.create("WJM.sale.SaleForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this},record:a});win=b.createWindow({title:"编辑报价单",
iconCls:"icon-grid",animCollapse:!1,width:800,height:750,constrainHeader:!0,layout:"fit",items:[a]});win.show()}else Ext.Msg.alert("提示","此报价单不可以编辑。");else Ext.Msg.alert("提示","请选择报价单")},onSaveSuccess:function(a){a.ownerCt.destroy();Ext.data.StoreManager.lookup(this.saleStore).loadPage(1);this.show()}});
Ext.define("WJM.sale.SaleReportModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSale","WJM.model.TSaleProduct"],id:"saledetail",init:function(){this.id=this.config.moduleId||"saledetail";this.title=this.config.menuText||"daily report/日常报表"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.sale.SaleGrid",{rmaAble:!0}),b=a.createWindow({id:this.id,title:this.title,width:980,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,
layout:"fit",items:b}));return b}});
Ext.define("WJM.sale.SaleTopGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],layout:{type:"border",padding:5},reportType:"daySaleReport",closeAction:"destroy",defaults:{split:!0},initComponent:function(){this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"search",text:"清空",scope:this,handler:this.clearSearch},{iconCls:"search",text:"打印列表",scope:this,handler:this.printGrid}]});var a=[];switch(this.reportType){case "daySaleReport":a.push({xtype:"datefield",
fieldLabel:"sale date/销售日期",labelWidth:150,name:"date",format:"Y-m-d",allowBlank:!1});this.storeId="SaleTopDayStore";break;case "monthlySaleReport":a.push({xtype:"datefield",fieldLabel:"sale date/销售日期",labelWidth:150,name:"date",format:"Y-m",allowBlank:!1});this.storeId="SaleTopMonthStore";break;case "bettenSaleReport":a.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"begin",format:"Y-m-d",allowBlank:!1}),a.push({xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,
name:"end",format:"Y-m-d",allowBlank:!1}),this.storeId="SaleTopBetweenStore"}Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"销售日期",bodyPadding:10,items:a},{store:this.storeId,split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",title:"日销售产品报表",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"item name/名称",dataIndex:"product_name",sortable:!0},{text:"total price/总价",
dataIndex:"all_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"total times/次数",dataIndex:"sale_times",sortable:!0}],viewConfig:{plugins:[]}}]});this.callParent()},onSearchClick:function(){if(this.down("form").getForm().isValid()){var a=this.down("form").getForm().getFieldValues(),b=Ext.data.StoreManager.lookup(this.storeId);Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.load()}},clearSearch:function(){this.down("form").getForm().getFields().each(function(a){a.setValue("")})},
printGrid:function(){Ext.ux.grid.Printer.print(this.down("grid"))}});
Ext.define("WJM.stock.PriceSearchModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TStock","WJM.model.TStockAndProduct"],id:"pricesearch",init:function(){this.id=this.config.moduleId||"pricesearch";this.title=this.config.menuText||"price search/价格搜索"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.stock.StockAndProductGrid"),b=a.createWindow({id:this.id,title:this.title,width:800,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,
layout:"fit",items:b}));return b}});
Ext.define("WJM.stock.StockAndProductGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel","WJM.model.TStockAndProduct"],layout:{type:"border",padding:5},defaults:{split:!0},initComponent:function(){this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick}]});Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"产品检索",layout:{columns:2,
type:"table"},bodyPadding:10,items:[{xtype:"textfield",fieldLabel:"item id/助记符",labelWidth:150,name:"product_id"},{xtype:"textfield",fieldLabel:"description",labelWidth:150,name:"product_name"}]},{store:"StockAndProductStore",split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"item id/助记符",dataIndex:"product_id",sortable:!0,width:100},{text:"description 1",dataIndex:"product_name",sortable:!0,width:200},{text:"price/价格",dataIndex:"product_price",
sortable:!0,width:150,xtype:"numbercolumn"},{text:"stock date/进货日期",dataIndex:"stock_time",sortable:!0,width:150}],viewConfig:{plugins:[]}}]});this.callParent()},onSearchClick:function(){var a=this.down("form").getForm().getFieldValues(),b=Ext.data.StoreManager.lookup("StockAndProductStore");Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.load()}});
Ext.define("WJM.stock.StockForm",{extend:"Ext.form.Panel",requires:["WJM.model.TStock"],height:680,width:400,bodyPadding:10,initComponent:function(){var a=this;Ext.applyIf(a,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{anchor:"100% -100",disableSelection:!1,loadMask:!0,xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"items id/助记符",dataIndex:"product_id",sortable:!0,width:100},{text:"barcode #/条码",dataIndex:"code",sortable:!0,width:100},{text:"description 1",dataIndex:"product_name",
sortable:!0,width:200},{text:"description 2",dataIndex:"product_name_cn",sortable:!0,width:200},{text:"cost/进货价",dataIndex:"price_income",sortable:!0,xtype:"numbercolumn",editor:{xtype:"adnumberfield",allowBlank:!1,minValue:0}},{text:"quantity/数量",dataIndex:"num",sortable:!0,xtype:"numbercolumn",editor:{xtype:"numberfield",allowBlank:!1,allowDecimals:!1,minValue:1}},{text:"vendor/供货商",dataIndex:"vendortName",sortable:!0}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1,listeners:{edit:a.calculateTotal,
scope:a}})],viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop",ddGroup:"TProduct",enableDrop:!0,enableDrag:!1})],listeners:{drop:function(a,c){for(var d=0;d<c.records.length;d++)c.records[d].set("num",1)},beforedrop:function(b,c){c.copy=!0;var d=a.down("gridpanel").getStore();c.records=Ext.Array.filter(c.records,function(a){return(a=d.getById(a.getId()))?(a.set("num",a.get("num")+1),!1):!0})}}}},{name:"id",xtype:"hiddenfield"},{name:"oper_id",xtype:"hiddenfield",
value:window.user.userId},{name:"stock_bill_code",xtype:"hiddenfield"},{name:"all_stock_price",fieldLabel:"total/总金额",allowBlank:!1,readOnly:!0},{name:"oper_name",fieldLabel:"Worker ID/操作员",allowBlank:!1,readOnly:!0,value:window.user.userName},{name:"oper_time",fieldLabel:"date/时间",allowBlank:!1,readOnly:!0,value:Ext.Date.format(new Date,"Y-m-d H:i:s")}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick},{xtype:"button",iconCls:"search",
text:"搜索产品",scope:this,handler:this.onProductSearchClick},{xtype:"label",text:"从任意产品列表拖动产品项到此产品列表区域"}]}]});a.callParent(arguments)},onSaveClick:function(){var a=this.getForm(),b=this,c=[];this.down("gridpanel").getStore().data.each(function(a){c.push(a.getData())});this.calculateTotal();a.isValid()&&this.submit({url:"stock.do?action=stock_submit",params:{productJsonList:Ext.JSON.encode(c)},success:function(){Ext.Msg.alert("提示","保存成功");b.clearForm();b.fireEvent("saveSuccess",b)},failure:function(a,
b){Ext.Msg.alert("提示",b.result.msg||"保存失败，请稍候重试")}})},onProductSearchClick:function(){var a=myDesktopApp.getDesktop(),b=a.getWindow("productsearch");b||(b=Ext.create("WJM.product.ProductGrid",{editAble:!1}),b=a.createWindow({id:"productsearch",title:"search/产品搜索",width:600,height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));b.show()},calculateTotal:function(){var a=0;this.down("gridpanel").getStore().data.each(function(b){a+=b.get("num")*b.get("price_income")});
this.getForm().findField("all_stock_price").setValue(a)},clearForm:function(){this.down("gridpanel").getStore().removeAll();this.getForm().findField("all_stock_price").setValue(0);this.getForm().findField("oper_time").setValue(Ext.Date.format(new Date,"Y-m-d H:i:s"))}});
Ext.define("WJM.stock.StockFormModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TStock","WJM.model.TStockProduct","WJM.model.TPurchase"],id:"stock",init:function(){this.id=this.config.moduleId||"stock";this.title=this.config.menuText||"Inventory/收货"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b?b.down("form").clearForm():(b=Ext.create("WJM.purchase.PurchaseGrid",{editAble:!1,receiveAble:!0,cashAble:!1}),b=a.createWindow({id:this.id,title:this.title,width:980,
height:600,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.stock.StockGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],layout:{type:"border",padding:5},defaults:{split:!0},initComponent:function(){this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"search",text:"清空",scope:this,handler:this.clearSearch}]});Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,
title:"库存检索",layout:{columns:2,type:"table",tableAttrs:{style:{width:"100%"}}},bodyPadding:10,items:[{xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,name:"oper_time_start",format:"Y-m-d"},{xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,name:"oper_time_end",format:"Y-m-d"},{xtype:"combobox",fieldLabel:"Work ID/操作员",labelWidth:150,allowBlank:!0,name:"oper_id",displayField:"name",valueField:"id",store:"EmployeeAllStore"}]},{store:"StockStore",split:!0,disableSelection:!1,
loadMask:!0,autoScroll:!0,region:"center",title:"进货单",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"Packing list #/进货单",dataIndex:"stock_bill_code",sortable:!0,width:150},{text:"Work ID/操作员",dataIndex:"oper_name",sortable:!0,width:100},{text:"total/合计",dataIndex:"all_stock_price",sortable:!0,width:100},{text:"date/时间",dataIndex:"oper_time",sortable:!0,width:200}],viewConfig:{plugins:[]},listeners:{selectionchange:function(a){if(a=a.getSelection()[0]){var b=Ext.data.StoreManager.lookup("StockProductStore");
b.getProxy().setExtraParam("stock_id",a.getId());b.load()}},scope:this},bbar:Ext.create("Ext.PagingToolbar",{store:"StockStore",displayInfo:!0,displayMsg:"显示库存 {0} - {1} 总共 {2}",emptyMsg:"没有库存数据"})},{store:"StockProductStore",split:!0,disableSelection:!1,loadMask:!0,height:150,autoScroll:!0,region:"south",title:"进货单明细",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"barcode #/条码",dataIndex:"product_code",sortable:!0,width:100},{text:"product name/名称",dataIndex:"product_name",sortable:!0,width:200},
{text:"vendor/供应商",dataIndex:"provider_name",sortable:!0,width:200},{text:"quantity/数量",dataIndex:"product_num",sortable:!0,width:100},{text:"price/价格",dataIndex:"product_price",sortable:!0,width:100},{text:"sub total/小计",dataIndex:"product_price",sortable:!0}],viewConfig:{plugins:[]}}]});Ext.data.StoreManager.lookup("StockStore").loadPage(1);this.callParent()},onSearchClick:function(){var a=this.down("form").getForm().getFieldValues(),b=Ext.data.StoreManager.lookup("StockStore");Ext.data.StoreManager.lookup("StockProductStore").removeAll();
Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.loadPage(1)},clearSearch:function(){this.down("form").getForm().getFields().each(function(a){a.setValue("")})}});
Ext.define("WJM.stock.StockReportModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TStock","WJM.model.TStockAndProduct","WJM.model.TStockProduct"],id:"stockdetail",init:function(){this.id=this.config.moduleId||"stockdetail";this.title=this.config.menuText||"stock detail/库存报表"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.stock.StockGrid"),b=a.createWindow({id:this.id,title:this.title,width:800,height:600,iconCls:"icon-grid",animCollapse:!1,
constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.vendor.VendorForm",{extend:"Ext.form.Panel",closeAction:"destroy",record:null,height:370,width:492,bodyPadding:10,initComponent:function(){Ext.applyIf(this,{defaults:{xtype:"textfield",anchor:"100%",labelWidth:150},items:[{name:"id",xtype:"hiddenfield"},{name:"recDate",xtype:"hiddenfield",value:Ext.Date.format(new Date,"Y-m-d H:i:s")},{name:"code",fieldLabel:"Company code/公司代码",labelWidth:150,allowBlank:!1},{name:"shortName",fieldLabel:"Company Name/公司名",allowBlank:!1},{name:"address",
fieldLabel:"Company Address/地址"},{name:"city",fieldLabel:"City/城市"},{name:"state",fieldLabel:"State/州"},{name:"postCode",fieldLabel:"Zip code/邮编"},{name:"mobile",fieldLabel:"Phone/电话"},{name:"FAX",fieldLabel:"Fax/传真"},{name:"linkMan",fieldLabel:"Contact Person/联系人"},{name:"EMail",fieldLabel:"Email/电子邮件"},{name:"http",fieldLabel:"Website/网址"},{name:"acc_balance",fieldLabel:"account balance/账户余额",xtype:"adnumberfield"},{name:"myMemo",fieldLabel:"remark/注释",xtype:"textareafield"}],dockedItems:[{xtype:"toolbar",
dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick}]}]});this.on("afterrender",this.initDragDorp,this);this.callParent(arguments);this.record&&this.loadRecord(this.record)},initDragDorp:function(){var a=this;this.dragDorp=Ext.create("Ext.dd.DropTarget",this.getEl().dom,{ddGroup:"TVendor",notifyEnter:function(){a.stopAnimation();a.getEl().highlight()},notifyDrop:function(b){b=b.dragData.records[0];a.getForm().loadRecord(b);return!0}})},onSaveClick:function(){var a=
this;this.getForm().isValid()&&this.submit({url:"provider.do?action=save",success:function(){Ext.Msg.alert("提示","保存成功");a.fireEvent("saveSuccess",a)},failure:function(){Ext.Msg.alert("提示","保存失败，请稍候重试")}})},beforeDestroy:function(){Ext.destroy(this.dragDorp);this.callParent()}});
Ext.define("WJM.vendor.VendorGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel","WJM.model.TVendor","Ext.grid.plugin.RowEditing","WJM.model.TPurchaseCashHistory"],editAble:!1,height:487,width:569,layout:{type:"border",padding:5},defaults:{split:!0},initComponent:function(){this.editTopBar=this.editAble?Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"add",text:"添加",scope:this,handler:this.onAddClick},{iconCls:"edit",text:"编辑",
scope:this,handler:this.onEditClick},{iconCls:"remove",text:"删除",scope:this,handler:this.onDeleteClick}]}):Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick}]});var a=[{anchor:"100%",height:100,xtype:"form",autoScroll:!0,title:"商家检索",region:"north",collapsible:!0,layout:{columns:2,type:"table"},bodyPadding:10,items:[{xtype:"textfield",fieldLabel:"company name/名称",labelWidth:150,name:"shortName"},{xtype:"textfield",fieldLabel:"company code/编号",
labelWidth:150,name:"code"},{xtype:"textfield",fieldLabel:"contact person/联系人",labelWidth:150,name:"linkMan"},{xtype:"textfield",fieldLabel:"phone/电话",labelWidth:150,name:"mobile"}]},{store:"VendorSearchStore",split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"company code/公司编号",dataIndex:"code",sortable:!0,width:150},{text:"name/名字",dataIndex:"shortName",sortable:!0,width:100},{text:"Company Address/地址",dataIndex:"address",
sortable:!0,width:100},{text:"Contact Person/联系人",dataIndex:"linkMan",sortable:!0,width:100},{text:"phone/电话",dataIndex:"mobile",sortable:!0},{text:"paid amount/已付金额",dataIndex:"paid_total",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"account balance/账户余额",dataIndex:"acc_balance",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"outstanding balance/未付余额",dataIndex:"invoice_balance",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"P.O. total/定单总额",dataIndex:"invoice_total",
xtype:"numbercolumn",format:"$0.00"},{text:"remark/备注",dataIndex:"myMemo"}],minHeight:200,viewConfig:{plugins:[Ext.create("Ext.grid.plugin.DragDrop",{ptype:"gridviewdragdrop",ddGroup:"TVendor"})]},bbar:Ext.create("Ext.PagingToolbar",{store:"VendorSearchStore",displayInfo:!0,displayMsg:"显示 供货商 {0} - {1} 总共 {2}",emptyMsg:"没有供货商数据"}),listeners:{selectionchange:function(a){if(a=a.getSelection()[0]){var b=Ext.data.StoreManager.lookup("PurchaseVendorCashStore");b.getProxy().setExtraParam("provider_id",
a.getId());b.load()}},scope:this}}];if(this.editAble){var b=Ext.create("WJM.cash.widget.PurchaseCashGrid",{region:"south",title:"供货商采购单列表",height:400,collapsed:!1,collapsible:!0,purchaseStore:"PurchaseVendorCashStore",purchaseProductStore:"PurchaseProductVendorCashStore",cashStore:"PurchaseCashHistoryStore"});b.on("saveSuccess",this.onSaveSuccess,this);a.push(b)}Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:a});Ext.data.StoreManager.lookup("VendorSearchStore").loadPage(1);this.callParent()},
onDeleteClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];a?Ext.Msg.confirm("提示","确定要删除此供货商么？",function(b){"yes"==b&&Ext.data.StoreManager.lookup("VendorSearchStore").remove(a)},this):Ext.Msg.alert("提示","请选择供应商")},onAddClick:function(){win=myDesktopApp.getDesktop().createWindow({title:"新建供应商",height:380,width:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[Ext.create("WJM.vendor.VendorForm",{listeners:{saveSuccess:this.onSaveSuccess,
scope:this}})]});win.show()},onEditClick:function(){var a=this.down("grid").getView().getSelectionModel().getSelection()[0];if(a){var b=myDesktopApp.getDesktop(),c=Ext.create("WJM.vendor.VendorForm",{listeners:{saveSuccess:this.onSaveSuccess,scope:this}});win=b.createWindow({title:"编辑供应商",height:380,width:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[c]});win.show();c.getForm().loadRecord(a)}else Ext.Msg.alert("提示","请选择供应商")},onSaveSuccess:function(a){a.ownerCt&&a.ownerCt.destroy();
Ext.data.StoreManager.lookup("VendorSearchStore").load()},onSearchClick:function(){var a=this.down("form").getForm().getFieldValues(),b=Ext.data.StoreManager.lookup("VendorSearchStore");Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.loadPage(1)}});
Ext.define("WJM.vendor.VendorManageModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TVendor"],id:"vendor",init:function(){this.id=this.config.moduleId||"vendor";this.title=this.config.menuText||"vendor/商家"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.vendor.VendorGrid",{editAble:!0}),b=a.createWindow({id:this.id,title:this.title,width:900,height:800,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:[b]}));return b}});
Ext.define("WJM.rma.DamageReportGrid",{extend:"Ext.panel.Panel",requires:["Ext.grid.Panel"],layout:{type:"border",padding:5},defaults:{split:!0},initComponent:function(){this.editTopBar=Ext.create("Ext.toolbar.Toolbar",{items:[{iconCls:"search",text:"搜索",scope:this,handler:this.onSearchClick},{iconCls:"search",text:"清空",scope:this,handler:this.clearSearch},{iconCls:"search",text:"打印列表",scope:this,handler:this.printGrid}]});var a=[];a.push({xtype:"datefield",fieldLabel:"start date/开始时间",labelWidth:150,
name:"begin",format:"Y-m-d",allowBlank:!1});a.push({xtype:"datefield",fieldLabel:"end date/结束时间",labelWidth:150,name:"end",format:"Y-m-d",allowBlank:!1});this.storeId="DamageReportStore";Ext.apply(this,{autoScroll:!0,dockedItems:[this.editTopBar],items:[{anchor:"100%",height:100,xtype:"form",region:"north",autoScroll:!0,collapsible:!0,title:"退货日期",bodyPadding:10,items:a},{store:this.storeId,split:!0,disableSelection:!1,loadMask:!0,autoScroll:!0,region:"center",title:"损害报表",xtype:"gridpanel",columns:[{xtype:"rownumberer"},
{text:"item name/名称",dataIndex:"product_name",sortable:!0},{text:"total price/总价",dataIndex:"all_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"total number/总损坏个数",dataIndex:"rma_num",sortable:!0}],viewConfig:{plugins:[]}}]});this.callParent()},onSearchClick:function(){if(this.down("form").getForm().isValid()){var a=this.down("form").getForm().getFieldValues(),b=Ext.data.StoreManager.lookup(this.storeId);Ext.Object.each(a,function(a,d){b.getProxy().setExtraParam(a,d)});b.load()}},
clearSearch:function(){this.down("form").getForm().getFields().each(function(a){a.setValue("")})},printGrid:function(){Ext.ux.grid.Printer.print(this.down("grid"))}});
Ext.define("WJM.rma.DamageReportModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TDamageReport"],id:"damagereport",init:function(){this.id=this.config.moduleId||"damagereport";this.title=this.config.menuText||"damage report/损坏报表"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.rma.DamageReportGrid",{}),b=a.createWindow({id:this.id,title:this.title,width:500,height:400,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:b}));
return b}});
Ext.define("WJM.rma.RmaForm",{extend:"Ext.panel.Panel",requires:["WJM.model.TSale"],autoScroll:!0,initComponent:function(){Ext.applyIf(this,{layout:{type:"border"},defaults:{split:!1},items:[{anchor:"100%",height:70,xtype:"form",region:"north",autoScroll:!0,title:"订单检索",bodyPadding:10,layout:{columns:3,type:"table",tableAttrs:{style:{width:"100%"},tdAttrs:{align:"center",valign:"middle"}}},items:[{xtype:"textfield",fieldLabel:"receive #/销售单号",labelWidth:150,allowBlank:!0,name:"sale_bill_code"},{xtype:"textfield",
fieldLabel:"invoice #/invoice单号",labelWidth:150,allowBlank:!0,name:"invoicecode"},{xtype:"textfield",fieldLabel:"customer mobile/电话",labelWidth:150,allowBlank:!0,name:"buyer_mobile"}]},{xtype:"form",title:"订单",region:"center",layout:"anchor",items:[{name:"id",xtype:"hiddenfield"},{xtype:"container",anchor:"100%",defaults:{xtype:"textfield",width:"90%",labelWidth:120,readOnly:!0,allowBlank:!0},layout:{columns:3,type:"table",tableAttrs:{style:{width:"100%"}},tdAttrs:{style:{width:"33.3%"}}},items:[{name:"oper_name",
fieldLabel:"Worker ID/操作员",readOnly:!0},{name:"oper_time",fieldLabel:"date/时间"},{name:"sub_total",fieldLabel:"sub total/合计",xtype:"adnumberfield"},{name:"tax",fieldLabel:"Tax/税(8.375%)",xtype:"adnumberfield"},{name:"all_price",fieldLabel:"Total/总计",xtype:"adnumberfield"},{fieldLabel:"name/客户名称",name:"buyer_name"},{fieldLabel:"address/客户地址",name:"buyer_address"},{fieldLabel:"State/州",name:"buyer_state"},{fieldLabel:"City/城市",name:"buyer_city"},{fieldLabel:"Zip Code/邮编",name:"buyer_postCode"},{fieldLabel:"Phone/电话",
name:"buyer_mobile"},{fieldLabel:"Discount/优惠",name:"discount",xtype:"adnumberfield",minValue:0,value:0},{xtype:"combobox",fieldLabel:"Payment Method/支付方式",name:"payment",displayField:"name",valueField:"value",store:"SalePaymentMethodStore"},{xtype:"combobox",fieldLabel:"Delivery Method/送货方式",name:"send_type",displayField:"name",valueField:"value",store:"SaleSendMethodStore"},{name:"remark",fieldLabel:"Remark/备注",allowBlank:!0,xtype:"textareafield",rows:2,colspan:3}]},{store:"SaleProductRmaStore",
anchor:"100% -170",minHeight:100,region:"south",disableSelection:!1,loadMask:!0,xtype:"gridpanel",columns:[{xtype:"rownumberer"},{text:"barcode #/条码",dataIndex:"product_code",sortable:!0},{text:"item name/名称",dataIndex:"product_name",sortable:!0},{text:"unit price/单价",dataIndex:"product_price",sortable:!0,xtype:"numbercolumn",format:"$0.00"},{text:"quantity/数量",dataIndex:"product_num",sortable:!0,xtype:"numbercolumn",format:"0,000"},{text:"sub total/小计",dataIndex:"sub_total",sortable:!0,xtype:"numbercolumn",
format:"$0.00"},{text:"RMAed credit quantity/已退货无损数量",dataIndex:"credit_num",sortable:!0,xtype:"numbercolumn",format:"0,000"},{text:"RMAed damage quantity/已退货损坏数量",dataIndex:"damage_num",sortable:!0,xtype:"numbercolumn",format:"0,000"},{text:"credit quantity/无损数量",dataIndex:"return_credit_num",sortable:!0,xtype:"numbercolumn",format:"0,000",editor:{xtype:"numberfield",name:"return_credit_num",allowDecimals:!1,minValue:0,allowBlank:!1,value:0}},{text:"damage quantity/有损数量",dataIndex:"return_damage_num",
sortable:!0,xtype:"numbercolumn",format:"0,000",editor:{xtype:"numberfield",name:"return_damage_num",allowDecimals:!1,minValue:0,allowBlank:!1,value:0}}],plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1})]}]}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"button",iconCls:"save",text:"保存",scope:this,handler:this.onSaveClick},{xtype:"button",iconCls:"search",text:"搜索订单",scope:this,handler:this.onSearchClick}]}]});this.callParent(arguments)},onSearchClick:function(){var a=
this.down('form[title="订单检索"]').getForm(),b=a.getFieldValues(),c=Ext.data.StoreManager.lookup("SaleRmaStore");Ext.data.StoreManager.lookup("SaleProductRmaStore").removeAll();a.isValid()&&(Ext.Object.each(b,function(a,b){c.getProxy().setExtraParam(a,b)}),c.load({scope:this,callback:function(a,b,c){c&&1<=a.length?(this.down('form[title="订单"]').loadRecord(a[0]),b=Ext.data.StoreManager.lookup("SaleProductRmaStore"),b.getProxy().setExtraParam("sale_id",a[0].getId()),b.load()):Ext.Msg.alert("提示","未找到相关订单")}}))},
onSaveClick:function(){var a=this,b=Ext.data.StoreManager.lookup("SaleRmaStore");0>=b.getCount()&&Ext.Msg.alert("提示","请先查询订单");0>=b.getAt(0).get("if_cashed")&&Ext.Msg.alert("提示","已经付款的订单才能退货！");var c=[],d=!1;this.down("gridpanel").getStore().data.each(function(a){0>a.get("product_num")-a.get("rma_num")-a.get("return_credit_num")-a.get("return_damage_num")&&(d=!0);c.push(a.getData())});d?Ext.Msg.alert("提示","退货数量超过购买数量"):this.down('form[title="订单"]').submit({url:"sale.do?action=rma_submit",params:{saleProducts:Ext.JSON.encode(c)},
success:function(b,c){Ext.Msg.alert("提示","保存成功");a.clearForm();window.open(location.context+"/sale.do?action=rma_print&id="+c.result.saleId,"_blank");a.fireEvent("saveSuccess",a)},failure:function(a,b){Ext.Msg.alert("提示",b.result.msg||"保存失败，请稍候重试")}})},clearForm:function(){this.down("gridpanel").getStore().removeAll();var a=this.down('form[title="订单"]').getForm().getFields();a.each(function(a){a.setValue("")});a=this.down('form[title="订单检索"]').getForm().getFields();a.each(function(a){a.setValue("")})}});
Ext.define("WJM.rma.RmaModel",{extend:"Ext.ux.desktop.Module",requires:["WJM.model.TSaleTop"],id:"RMA",init:function(){this.id=this.config.moduleId||"RMA";this.title=this.config.menuText||"RMA/退货"},createWindow:function(){var a=this.app.getDesktop(),b=a.getWindow(this.id);b||(b=Ext.create("WJM.rma.RmaForm",{}),b=a.createWindow({id:this.id,title:this.title,width:900,height:500,iconCls:"icon-grid",animCollapse:!1,constrainHeader:!0,layout:"fit",items:b}));return b}});
Ext.define("WJM.App",{extend:"Ext.ux.desktop.App",requires:"Ext.window.MessageBox Ext.ux.desktop.ShortcutModel WJM.Settings WJM.FormWriter WJM.ShortcutModel WJM.product.ProductAlert".split(" "),init:function(){this.callParent();WJM.Config.hasProductManageRole&&WJM.product.ProductAlert.checkProduct()},getModules:function(){var a=[];WJM.Config.hasOperationMenu()&&a.push(this.createOperationMenu());WJM.Config.hasAdminMenu()&&a.push(this.createAdminMenu());WJM.Config.hasReportMenu()&&a.push(this.createReportMenu());
for(var b=this.getUserModels(),c=0;c<b.length;c++){var d=b[c];d.moduleName&&""!=d.moduleName&&a.push(Ext.create(d.moduleName,d))}return a},getDesktopConfig:function(){for(var a=this.callParent(),b=[],c=this.getUserModels(),d=0;d<c.length;d++){var e=c[d];b.push({powerId:e.powerId,name:e.menuText,iconCls:e.iconClsBig||"grid-shortcut",module:e.moduleId})}return Ext.apply(a,{contextMenuItems:[{text:"桌面设置",handler:this.onSettings,scope:this}],shortcuts:Ext.create("Ext.data.Store",{model:"WJM.ShortcutModel",
data:b}),wallpaper:"wallpapers/Wood-Sencha.jpg",wallpaperStretch:!1,shortcutTpl:['<div class="g-area f-clear">','<tpl for=".">','<tpl if="this.isOperaction(powerId)">','<div class="ux-desktop-shortcut" id="{name}-shortcut">','<div class="ux-desktop-shortcut-icon {iconCls}">','<img src="',Ext.BLANK_IMAGE_URL,'" title="{name}">',"</div>",'<span class="ux-desktop-shortcut-text">{name}</span>',"</div>","</tpl>","</tpl>","</div>",'<div class="g-area f-clear">','<tpl for=".">','<tpl if="this.isAdmin(powerId)">',
'<div class="ux-desktop-shortcut" id="{name}-shortcut">','<div class="ux-desktop-shortcut-icon {iconCls}">','<img src="',Ext.BLANK_IMAGE_URL,'" title="{name}">',"</div>",'<span class="ux-desktop-shortcut-text">{name}</span>',"</div>","</tpl>","</tpl>","</div>",'<div class="g-area f-clear">','<tpl for=".">','<tpl if="this.isReport(powerId)">','<div class="ux-desktop-shortcut" id="{name}-shortcut">','<div class="ux-desktop-shortcut-icon {iconCls}">','<img src="',Ext.BLANK_IMAGE_URL,'" title="{name}">',
"</div>",'<span class="ux-desktop-shortcut-text">{name}</span>',"</div>","</tpl>","</tpl>","</div>",'<div class="x-clear"></div>',{isOperaction:function(a){return Ext.Array.contains(WJM.Config.operationPowerCode,parseInt(a))},isAdmin:function(a){return Ext.Array.contains(WJM.Config.adminPowerCode,parseInt(a))},isReport:function(a){return Ext.Array.contains(WJM.Config.reportPowerCode,parseInt(a))}}]})},getStartConfig:function(){var a=this.callParent();return Ext.apply(a,{title:WJM.Config.user.userName,
iconCls:"user",height:300,toolConfig:{width:100,items:[{text:"桌面设置",iconCls:"settings",handler:this.onSettings,textAlign:"left",scope:this},"-",{text:"退出",iconCls:"logout",textAlign:"left",handler:this.onLogout,scope:this}]}})},getTaskbarConfig:function(){var a=this.callParent(),b=this;return Ext.apply(a,{quickStart:[{name:"折叠",iconCls:"accordion",tooltipText:"折叠全部窗口",handler:function(){b.getDesktop().cascadeWindows()}},{name:"平铺",tooltipText:"平铺全部窗口",iconCls:"icon-grid",handler:function(){b.getDesktop().tileWindows()}}],
trayItems:[{xtype:"trayclock",flex:1}]})},onLogout:function(){Ext.Msg.confirm("Logout","Are you sure you want to logout?",function(a){"yes"==a&&(location.href=location.context+"/login.do?action=logout")},this)},onSettings:function(){(new WJM.Settings({desktop:this.desktop})).show()},createOperationMenu:function(){Ext.require("WJM.MenuItem");for(var a=[],b=Ext.Array.clone(WJM.Config.operationPowerCode),c=0;c<b.length;c++){var d=b[c];Ext.Array.contains(WJM.Config.user.userPowers,d)&&a.push(WJM.Config.powerOperationModule[""+
d])}return Ext.create("WJM.MenuItem",{menuText:"operation/操作",menuItems:a,iconCls:"ico-operation"})},createAdminMenu:function(){Ext.require("WJM.MenuItem");for(var a=[],b=Ext.Array.clone(WJM.Config.adminPowerCode),c=0;c<b.length;c++){var d=b[c];Ext.Array.contains(WJM.Config.user.userPowers,d)&&a.push(WJM.Config.powerOperationModule[""+d])}return Ext.create("WJM.MenuItem",{menuText:"admin/管理",menuItems:a,iconCls:"ico-operation"})},createReportMenu:function(){Ext.require("WJM.MenuItem");for(var a=[],
b=Ext.Array.clone(WJM.Config.reportPowerCode),c=0;c<b.length;c++){var d=b[c];Ext.Array.contains(WJM.Config.user.userPowers,d)&&a.push(WJM.Config.powerOperationModule[""+d])}return Ext.create("WJM.MenuItem",{menuText:"report/报表",menuItems:a,iconCls:"ico-operation"})},getUserModels:function(){for(var a=WJM.Config.user.userPowers,b=[],c=Ext.Array.clone(WJM.Config.operationPowerCode),d=0;d<c.length;d++){var e=c[d];Ext.Array.contains(a,e)&&(e=WJM.Config.powerOperationModule[new String(e)])&&b.push(e)}c=
Ext.Array.clone(WJM.Config.adminPowerCode);for(d=0;d<c.length;d++)e=c[d],Ext.Array.contains(a,e)&&(e=WJM.Config.powerOperationModule[new String(e)])&&b.push(e);c=Ext.Array.clone(WJM.Config.reportPowerCode);for(d=0;d<c.length;d++)e=c[d],Ext.Array.contains(a,e)&&(e=WJM.Config.powerOperationModule[new String(e)])&&b.push(e);return b}});
